!function(){function e(){window.log=console.log.bind(console),window.addEventListener("wheel",function(e){e.preventDefault()}),i(["event","globals","managers/login"],function(e,t,i){function n(){document.body.style.height=window.innerHeight+"px"}t.setHTMLDevices();var s=new i;window.login=s,window.addEventListener("resize",function(){window.scroll(0,0),n()}),n()})}var t,i,n;!function(e){function s(e,t){return y.call(e,t)}function o(e,t){var i,n,s,o,r,a,l,c,u,h,d=t&&t.split("/"),f=g.map,_=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=d.concat(e.split("/")),c=0;c<e.length;c+=1)if(h=e[c],"."===h)e.splice(c,1),c-=1;else if(".."===h){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||_)&&f){for(i=e.split("/"),c=i.length;c>0;c-=1){if(n=i.slice(0,c).join("/"),d)for(u=d.length;u>0;u-=1)if(s=f[d.slice(0,u).join("/")],s&&(s=s[n])){o=s,r=c;break}if(o)break;!a&&_&&_[n]&&(a=_[n],l=c)}!o&&a&&(o=a,r=l),o&&(i.splice(0,r,o),e=i.join("/"))}return e}function r(t,i){return function(){return f.apply(e,b.call(arguments,0).concat([t,i]))}}function a(e){return function(t){return o(t,e)}}function l(e){return function(t){p[e]=t}}function c(t){if(s(v,t)){var i=v[t];delete v[t],w[t]=!0,d.apply(e,i)}if(!s(p,t)&&!s(w,t))throw new Error("No "+t);return p[t]}function u(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function h(e){return function(){return g&&g.config&&g.config[e]||{}}}var d,f,_,m,p={},v={},g={},w={},y=Object.prototype.hasOwnProperty,b=[].slice;_=function(e,t){var i,n=u(e),s=n[0];return e=n[1],s&&(s=o(s,t),i=c(s)),s?e=i&&i.normalize?i.normalize(e,a(t)):o(e,t):(e=o(e,t),n=u(e),s=n[0],e=n[1],s&&(i=c(s))),{f:s?s+"!"+e:e,n:e,pr:s,p:i}},m={require:function(e){return r(e)},exports:function(e){var t=p[e];return"undefined"!=typeof t?t:p[e]={}},module:function(e){return{id:e,uri:"",exports:p[e],config:h(e)}}},d=function(t,i,n,o){var a,u,h,d,f,g,y=[];if(o=o||t,"function"==typeof n){for(i=!i.length&&n.length?["require","exports","module"]:i,f=0;f<i.length;f+=1)if(d=_(i[f],o),u=d.f,"require"===u)y[f]=m.require(t);else if("exports"===u)y[f]=m.exports(t),g=!0;else if("module"===u)a=y[f]=m.module(t);else if(s(p,u)||s(v,u)||s(w,u))y[f]=c(u);else{if(!d.p)throw new Error(t+" missing "+u);d.p.load(d.n,r(o,!0),l(u),{}),y[f]=p[u]}h=n.apply(p[t],y),t&&(a&&a.exports!==e&&a.exports!==p[t]?p[t]=a.exports:h===e&&g||(p[t]=h))}else t&&(p[t]=n)},t=i=f=function(t,i,n,s,o){return"string"==typeof t?m[t]?m[t](i):c(_(t,i).f):(t.splice||(g=t,i.splice?(t=i,i=n,n=null):t=e),i=i||function(){},"function"==typeof n&&(n=s,s=o),s?d(e,t,i,n):setTimeout(function(){d(e,t,i,n)},4),f)},f.config=function(e){return g=e,g.deps&&f(g.deps,g.callback),f},t._defined=p,n=function(e,t,i){t.splice||(i=t,t=[]),s(p,e)||s(v,e)||(v[e]=[e,t,i])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("event",[],function(){function e(){this.init()}return e.prototype={listeners:null,init:function(){this.listeners=[]},addListener:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},removeListener:function(e,t){if(!this.listeners[e])return!1;for(var i=0;i<this.listeners[e].length;i++)if(this.listeners[e][i]==t)return this.listeners[e]=this.listeners[e].splice(i,1),!0},trigger:function(e,t){function i(e){setTimeout(function(){e(t)},0)}if(!this.listeners[e])return!1;for(var n=0;n<this.listeners[e].length;n++)i(this.listeners[e][n]);return!0}},new e}),n("globals",[],function(){return{isiOS:function(){return this.hasDeviceType("iOS")},isPC:function(){return this.hasDeviceType("PC")},isMac:function(){return this.hasDeviceType("Mac")},isComputer:function(){return this.hasDeviceType("computer")},isPhone:function(){return this.hasDeviceType("phone")},hasDeviceType:function(e){return-1!==this.getDeviceType().indexOf(e)},getDeviceType:function(){localStorage.deviceType;var e=[],t=navigator.userAgent;return t.match(/OS 7/g)?(e.push("iOS"),t.match(/iPad/g)?(e.push("iPad"),e.push("tablet")):t.match(/iPhone/g)&&(e.push("iPhone"),e.push("phone"))):t.match(/Mac/g)?(e.push("Mac"),e.push("computer")):(e.push("PC"),e.push("computer")),localStorage.deviceType=JSON.stringify(e),e},setHTMLDevices:function(){var e=this.getDeviceType(),t=document.body;t.className=e.join(" ")}}}),n("class",[],function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;return this.Class=function(){},Class.extend=function(i){function n(){!e&&this.init&&this.init.apply(this,arguments)}var s=this.prototype;e=!0;var o=new this;e=!1;for(var r in i)o[r]="function"==typeof i[r]&&"function"==typeof s[r]&&t.test(i[r])?function(e,t){return function(){var i=this._super;this._super=s[e];var n=t.apply(this,arguments);return this._super=i,n}}(r,i[r]):i[r];return n.prototype=o,n.prototype.constructor=n,n.extend=arguments.callee,n},this.Class}),n("section",["class"],function(e){var t=e.extend({id:null,element:null,init:function(){this.element=document.getElementById(this.id)},show:null,hide:null,afterShow:function(){this.element.style.display="block"},afterHide:function(){this.element.style.display=""}});return t}),n("tapHandler",[],function(){function e(e,t){this.init(e,t)}return e.prototype={_element:null,_options:null,_distCutoff:20,_timeCutoff:500,_startType:null,_startTouchId:null,_startTime:null,_startX:null,_startY:null,_startScale:null,_lastX:null,_lastY:null,_lastScale:null,_offset:null,_inTouch:!1,_inGesture:!1,_ignoreGestures:!1,init:function(e,t){this._element=e,this._options=t,this._move=this._move.bind(this),this._end=this._end.bind(this),this._gestureChange=this._gestureChange.bind(this),this._gestureEnd=this._gestureEnd.bind(this),this._offset={x:e.offsetLeft,y:e.offsetTop},this._element.addEventListener("mousedown",this._start.bind(this)),this._element.addEventListener("touchstart",this._start.bind(this)),this._element.addEventListener("gesturestart",this._gestureStart.bind(this))},ignoreGestures:function(e){this._ignoreGestures=e},_start:function(e){e.touches&&(this._startTouchId=e.touches[e.touches.length-1].identifier),this._processEvent(e),this._inGesture||(this._startType="mouse",e.touches&&(this._startType="touch"),this._inTouch=!0,this._startTime=e.timeStamp,this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._options.start&&this._options.start(e),"touch"==this._startType?(document.addEventListener("touchmove",this._move),document.addEventListener("touchend",this._end)):"mouse"==this._startType&&(document.addEventListener("mousemove",this._move),document.addEventListener("mouseup",this._end)))},_move:function(e){this._processEvent(e),this._lastX=e.x,this._lastY=e.y,this._options.move&&this._options.move(e)},_end:function(e){if(!e)return this._endTouchHandlers(),this._options.end&&this._options.end(),void 0;if(e.wasTap=!1,!e.touches||-1===this._indexOfTouch(e,this._startTouchId)){this._endTouchHandlers(),this._processEvent(e);var t=Math.sqrt((e.x-this._startX)*(e.x-this._startX)+(e.y-this._startY)*(e.y-this._startY));t<this._distCutoff&&e.timeStamp-this._startTime<this._timeCutoff&&(e.wasTap=!0,this._options.tap&&this._options.tap(e)),this._options.end&&this._options.end(e),this._inTouch=!1,e&&(e.preventDefault(),e.stopImmediatePropagation())}},_gestureStart:function(e){this._ignoreGestures||(this._inGesture=!0,this._end(),this._processEvent(e),this._processGesture(e),this._startTime=e.timeStamp,this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._startScale=this._lastScale=e.scale,document.addEventListener("gesturechange",this._gestureChange),document.addEventListener("gestureend",this._gestureEnd))},_gestureChange:function(e){this._processEvent(e),this._processGesture(e),this._lastX=e.x,this._lastY=e.y,this._lastScale=e.scale,this._lastScale=e.scale,this._options.gesture&&this._options.gesture(e)},_gestureEnd:function(e){this._processEvent(e),this._processGesture(e),document.removeEventListener("gesturechange",this._gestureChange),document.removeEventListener("gestureend",this._gestureEnd),this._inGesture=!1},_endTouchHandlers:function(){"touch"==this._startType?(document.removeEventListener("touchmove",this._move),document.removeEventListener("touchend",this._end)):"mouse"==this._startType&&(document.removeEventListener("mousemove",this._move),document.removeEventListener("mouseup",this._end))},_processEvent:function(e){e.isTouch=e.touches?!0:!1;var t=-1;e.touches&&e.touches.length>0&&-1!==(t=this._indexOfTouch(e,this._startTouchId))?(e.x=e.touches[t].clientX,e.y=e.touches[t].clientY):e.clientX?(e.x=e.clientX,e.y=e.clientY):e.pageX?(e.x=e.pageX,e.y=e.pageY):(e.x=this._lastX,e.y=this._lastY),e.distFromLeft=e.x-this._offset.x,e.distFromTop=e.y-this._offset.y,e.xFromLast=e.x-this._lastX,e.yFromLast=e.y-this._lastY},_processGesture:function(e){e.scaleFromLast=e.scale-this._lastScale},_indexOfTouch:function(e,t){var i=-1;if(e.touches&&t)for(var n=0;n<e.touches.length;n++)if(e.touches[n].identifier==t){i=n;break}return i}},e}),n("sections/login",["event","section","tapHandler"],function(e,t,i){var n=t.extend({id:"login",init:function(){this._super();var e=document.getElementById("loginbutton");new i(e,{tap:this._loginClicked.bind(this)})},_loginClicked:function(){setTimeout(function(){e.trigger("login")},400)}});return n}),n("platform",["class"],function(e){var t=e.extend({_b:null,standalone:null,transition:null,transitionEnd:null,animation:null,transform:null,transformOrigin:null,mouseWheel:null,init:function(){this._b=document.body,this.standalone=!!window.navigator.standalone,this.transition=this.addPrefix("transition"),this.transitionEnd=this.addPrefix("transitionEnd"),this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin"),this.mouseWheel="undefined"!=typeof window.onwheel?"wheel":"mousewheel",window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB||window.oIndexedDB},addPrefix:function(e){var t="",i=["ms","webkit","mox","o"],n=this._b.style;if("string"==typeof n[e])t="";else for(var s=0;s<i.length;s++)if("string"==typeof n["-"+i[s]+"-"+e]){t=i[s];break}var o=t.length>0?e.charAt(0).toUpperCase()+e.slice(1):e;return t?t+o:o}}),i=new t;return window.platform=i,i}),n("helpers",[],function(){return{parentEleWithClassname:function(e,t){return null!=e&&e.classList?e.classList.contains(t)?e:this.parentEleWithClassname(e.parentNode,t):!1},screenToWorld:function(e,t,i){return{x:(t-e.offsetX)/e.scale,y:(i-e.offsetY)/e.scale}},worldToScreen:function(e,t,i){return{x:t*e.scale+e.offsetX,y:i*e.scale+e.offsetY}},getCurveControlPoints:function(e){function t(e){var t=e.length,i=new Array(t),n=new Array(t),s=2;i[0]=e[0]/s;for(var o=1;t>o;o++)n[o]=1/s,s=(t-1>o?4:3.5)-n[o],i[o]=(e[o]-i[o-1])/s;for(var o=1;t>o;o++)i[t-o-1]-=n[t-o]*i[t-o];return i}var i=e.length-1,n=[],s=[];if(1>i)return console.error("Must have at least two knots"),void 0;if(1==i)return n.push([]),n[0]=[(2*e[0][0]+e[1][0])/3,(2*e[0][1]+e[1][1])/3],s.push([]),s[0]=[2*n[0][0]-e[0][0],2*n[0][1]-e[0][1]],[[n[0],s[0]]];for(var o=new Array(i),r=1;i-1>r;++r)o[r]=4*e[r][0]+2*e[r+1][0];o[0]=e[0][0]+2*e[1][0],o[i-1]=(8*e[i-1][0]+e[i][0])/2;for(var a=t(o),r=1;i-1>r;++r)o[r]=4*e[r][1]+2*e[r+1][1];o[0]=e[0][1]+2*e[1][1],o[i-1]=(8*e[i-1][1]+e[i][1])/2;var l=t(o);n=new Array(i),s=new Array(i);for(var r=0;i>r;++r)n[r]=[a[r],l[r]],s[r]=i-1>r?[2*e[r+1][0]-a[r+1],2*e[r+1][1]-l[r+1]]:[(e[i][0]+a[i-1])/2,(e[i][1]+l[i-1])/2];for(var c=new Array(i),r=0;i>r;++r)c[r]=[n[r],s[r]];return c}}}),n("dataBacking/baseBacking",["class"],function(e){var t=e.extend({init:function(){throw"Do not use this class without extending it"},getFiles:function(){console.error("Implement this function")},getFile:function(){console.error("Implement this function")},getFileActions:function(){console.error("Implement this function")},createFile:function(){console.error("Implement this function")},renameFile:function(){console.error("Implement this function")},deleteFile:function(){console.error("Implement this function")},addAction:function(){console.error("Implement this function")},removeAction:function(){console.error("Implement this function")},updateFileModified:function(){console.error("Implement this function")},clearAll:function(){console.error("Implement this function")},_getGuid:function(){return"T^"+Date.now()+"-"+Math.round(1e6*Math.random())}});return t}),n("db",[],function(){var e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,t=window.IDBKeyRange||window.webkitIDBKeyRange,i={readonly:"readonly",readwrite:"readwrite"},n=Object.prototype.hasOwnProperty;if(!e)return console.warn("IndexedDB required"),void 0;var s=function(e){return e},o=function(){var e,t=[],i=function(i,n){if(t){n=n||[],e=e||[i,n];for(var s=0,o=t.length;o>s;s++)t[s].apply(e[0],e[1]);t=[]}};this.add=function(){for(var n=0,s=arguments.length;s>n;n++)t.push(arguments[n]);return e&&i(),this},this.execute=function(){return i(this,arguments),this}},r=function(e){var t="progress",i=[["resolve","done",new o,"resolved"],["reject","fail",new o,"rejected"],["notify","progress",new o]],n={},s={state:function(){return t},then:function(){var e=arguments;return r(function(t){i.forEach(function(i,s){var o=e[s];n[i[1]]("function"==typeof o?function(){var e=o.apply(this,arguments);e&&"function"==typeof e.promise&&e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}:t[i[0]])})}).promise()},promise:function(e){return e?(Object.keys(s).forEach(function(t){e[t]=s[t]}),e):s}};return i.forEach(function(e){var i=e[2],o=e[3];s[e[1]]=i.add,o&&i.add(function(){t=o}),n[e[0]]=i.execute}),s.promise(n),e&&e.call(n,n),n},a=function(e,t){var s=this,o=!1;this.add=function(t){if(o)throw"Database has been closed";for(var n=[],a=0;a<arguments.length-1;a++)n[a]=arguments[a+1];var l=e.transaction(t,i.readwrite),c=l.objectStore(t),u=r();return n.forEach(function(e){var t;if(e.item&&e.key){var i=e.key;e=e.item,t=c.add(e,i)}else t=c.add(e);t.onsuccess=function(t){var i=t.target,n=i.source.keyPath;null===n&&(n="__id__"),Object.defineProperty(e,n,{value:i.result,enumerable:!0}),u.notify()}}),l.oncomplete=function(){u.resolve(n,s)},l.onerror=function(e){u.reject(n,e)},l.onabort=function(e){u.reject(n,e)},u.promise()},this.update=function(t){if(o)throw"Database has been closed";for(var n=[],a=0;a<arguments.length-1;a++)n[a]=arguments[a+1];var l=e.transaction(t,i.readwrite),c=l.objectStore(t),u=(c.keyPath,r());return n.forEach(function(e){var t;if(e.item&&e.key){var i=e.key;e=e.item,t=c.put(e,i)}else t=c.put(e);t.onsuccess=function(){u.notify()}}),l.oncomplete=function(){u.resolve(n,s)},l.onerror=function(e){u.reject(n,e)},l.onabort=function(e){u.reject(n,e)},u.promise()},this.remove=function(t,n){if(o)throw"Database has been closed";var s=e.transaction(t,i.readwrite),a=s.objectStore(t),l=r();return a.delete(n),s.oncomplete=function(){l.resolve(n)},s.onerror=function(e){l.reject(e)},l.promise()},this.clear=function(t){if(o)throw"Database has been closed";var n=e.transaction(t,i.readwrite),s=n.objectStore(t),a=r();return s.clear(),n.oncomplete=function(){a.resolve()},n.onerror=function(e){a.reject(e)},a.promise()},this.close=function(){if(o)throw"Database has been closed";e.close(),o=!0,delete h[t]},this.get=function(t,i){if(o)throw"Database has been closed";var n=e.transaction(t),s=n.objectStore(t),a=r(),l=s.get(i);return l.onsuccess=function(e){a.resolve(e.target.result)},n.onerror=function(e){a.reject(e)},a.promise()},this.query=function(t,i){if(o)throw"Database has been closed";return new l(t,e,i)};for(var a=0,c=e.objectStoreNames.length;c>a;a++)!function(e){s[e]={};for(var t in s)n.call(s,t)&&"close"!==t&&(s[e][t]=function(t){return function(){var i=[e].concat([].slice.call(arguments,0));return s[t].apply(s,i)}}(t))}(e.objectStoreNames[a])},l=function(e,n,o){var a=this,l=!1,c=function(s,a,c,u,h,d,f){var _=n.transaction(e,l?i.readwrite:i.readonly),m=_.objectStore(e),p=o?m.index(o):m,v=s?t[s].apply(null,a):null,g=[],w=r(),y=[v],h=h?h:null,d=d?d:[],b=0;"count"!==c&&y.push(u||"next");var x=l?Object.keys(l):!1,E=function(e){for(var t=0;t<x.length;t++){var i=x[t],n=l[i];n instanceof Function&&(n=n(e)),e[i]=n}return e};return p[c].apply(p,y).onsuccess=function(e){var t=e.target.result;if("number"==typeof t)g=t;else if(t)if(null!==h&&h[0]>b)b=h[0],t.advance(h[0]);else if(null!==h&&b>=h[0]+h[1]);else{var i=!0,n="value"in t?t.value:t.key;d.forEach(function(e){e&&e.length&&(i=2===e.length?n[e[0]]===e[1]:e[0].apply(void 0,[n]))}),i&&(b++,g.push(f(n)),l&&(n=E(n),t.update(n))),t.continue()}},_.oncomplete=function(){w.resolve(g)},_.onerror=function(e){w.reject(e)},_.onabort=function(e){w.reject(e)},w.promise()},u=function(e,t){var i="next",n="openCursor",o=[],r=null,a=s,u=!1,h=function(){return c(e,t,n,u?i+"unique":i,r,o,a)},d=function(){return r=Array.prototype.slice.call(arguments,0,2),1==r.length&&r.unshift(0),{execute:h}},f=function(){return i=null,n="count",{execute:h}},_=function(){return n="openKeyCursor",{desc:p,execute:h,filter:m,distinct:v,map:w}},m=function(){return o.push(Array.prototype.slice.call(arguments,0,2)),{keys:_,execute:h,filter:m,desc:p,distinct:v,modify:g,limit:d,map:w}},p=function(){return i="prev",{keys:_,execute:h,filter:m,distinct:v,modify:g,map:w}},v=function(){return u=!0,{keys:_,count:f,execute:h,filter:m,desc:p,modify:g,map:w}},g=function(e){return l=e,{execute:h}},w=function(e){return a=e,{execute:h,count:f,keys:_,filter:m,desc:p,distinct:v,modify:g,limit:d,map:w}};return{execute:h,count:f,keys:_,filter:m,desc:p,distinct:v,modify:g,limit:d,map:w}};"only bound upperBound lowerBound".split(" ").forEach(function(e){a[e]=function(){return new u(e,arguments)}}),this.filter=function(){var e=new u(null,null);return e.filter.apply(e,arguments)},this.all=function(){return this.filter()}},c=function(e,t,i){"function"==typeof t&&(t=t());for(var s in t){var o,r=t[s];o=!n.call(t,s)||i.objectStoreNames.contains(s)?e.currentTarget.transaction.objectStore(s):i.createObjectStore(s,r.key);for(var a in r.indexes){var l=r.indexes[a];o.createIndex(a,l.key||a,Object.keys(l).length?l:{unique:!1})}}},u=function(e,t){var i=e.target.result,n=new a(i,t),s=r();return s.resolve(n),h[t]=i,s.promise()},h={},d={version:"0.9.0",open:function(t){var i,n=r(),s=h[t.server];if(s)for(var o in t.schema)s.objectStoreNames.contains(o)||(s.close(),delete h[t.server]);return h[t.server]?u({target:{result:h[t.server]}},t.server,t.version,t.schema).done(n.resolve).fail(n.reject).progress(n.notify):(i=e.open(t.server,t.version),i.onsuccess=function(e){u(e,t.server,t.version,t.schema).done(n.resolve).fail(n.reject).progress(n.notify)},i.onupgradeneeded=function(e){c(e,t.schema,e.target.result)},i.onerror=function(e){n.reject(e)}),n.promise()}};return d}),n("dataBacking/indexedDBBacking",["dataBacking/baseBacking","db"],function(e,t){var i=e.extend({_server:null,_files:null,_initCallbacks:null,init:function(){this._files=[],this._initCallbacks=[],t.open({server:"draw",version:1,schema:{files:{key:{keyPath:"id"},indexes:{id:{unique:!0},modifiedTime:{}}}}}).done(function(e){this._server=e;for(var t=0;t<this._initCallbacks.length;t++){var i=this._initCallbacks[t];i.func.apply(this,i.args)}}.bind(this)).fail(function(e){console.error("Failed setting up database",e)})},getFiles:function(e){if(!this._server)return this._doLater(this.getFiles,[e]),void 0;if(!e)throw"You must specify a callback";this._server.files.query("modifiedTime").all().desc().execute().done(function(t){e(t)}.bind(this))},getFile:function(e,t){return this._server?(this._server.files.query("id").only(e).execute().done(function(e){t(e[0])}.bind(this)),void 0):(this._doLater(this.getFile,[e,t]),void 0)},_getFileServer:function(e,i){this._files[e]?i(this._files[e]):t.open({server:e,version:1,schema:{actions:{key:{keyPath:"id",autoIncrement:!0}}}}).done(function(t){this._files[e]=t,i(t)}.bind(this)).fail(function(e){console.error("Failed to create file database",e)})},getFileActions:function(e,t){return this._server?(this._getFileServer(e,function(e){e.actions.query().all().execute().done(function(e){t(e)}.bind(this))}.bind(this)),void 0):(this._doLater(this.getFileActions,[e,t]),void 0)},createFile:function(e){if(!this._server)return this._doLater(this.createFile,[e]),void 0;if(!e)throw"You must specify a callback";var t=this._getGuid(),i={id:t,name:"Untitled File",modifiedTime:Date.now()};this._server.files.add(i).done(function(t){var i=t[0];this._getFileServer(i.id,function(){e(i)}.bind(this))}.bind(this)).fail(function(e){console.error("fail to add file to file list",e)})},renameFile:function(e,t){return this._server?(this._server.files.query("id").only(e).modify({name:t}).execute().done(function(){}).fail(function(e){console.error("Couldn't find file",e)}),void 0):(this._doLater(this.renameFile,[e]),void 0)},deleteFile:function(e){return this._server?(this._server.files.remove(e).done(function(){var t=indexedDB.deleteDatabase(e);t.onerror=function(e){console.error("Error deleting database",e)},delete localStorage[e]}).fail(function(){console.error("Failed to delete file from file table",e)}),void 0):(this._doLater(this.deleteFile,[e]),void 0)},addAction:function(e,t){this._getFileServer(e,function(e){e.actions.add(t).done(function(){}).fail(function(e){console.error("fail to write",e)})}.bind(this))},removeAction:function(e,t){this._getFileServer(e,function(e){e.actions.remove(t).done(function(){})}.bind(this))},updateFileModified:function(e,t){return this._server?(this._server.files.query("id").only(e).modify({modifiedTime:t}).execute().done(function(){}).fail(function(e){console.error("Couldn't find file",e)}),void 0):(this._doLater(this.updateFileModified,[e,t]),void 0)},clearAll:function(){this.getFiles(function(e){for(var t=0;t<e.length;t++)this.deleteFile(e[t].id)}.bind(this))},_doLater:function(e,t){this._initCallbacks.push({func:e,args:t})}});return i}),n("dataBacking/webSQLBacking",["dataBacking/baseBacking"],function(e){var t=e.extend({_db:null,init:function(){this._error=this._error.bind(this),this._db=openDatabase("draw","1.0","draw",2097152,this._databaseCreated.bind(this))},getFiles:function(e){this._db.readTransaction(function(t){t.executeSql("SELECT * FROM `files` ORDER BY modifiedTime DESC",[],function(t,i){var n=this._convertResultToObject(i);e(n)}.bind(this))}.bind(this))},getFile:function(e,t){this._db.readTransaction(function(i){i.executeSql("SELECT * FROM `files` WHERE `id` = ?",[e],function(e,i){var n=this._convertResultToObject(i);t(n[0])}.bind(this))}.bind(this))},getFileActions:function(e,t){this._db.readTransaction(function(i){i.executeSql("SELECT * FROM `"+e+"`",[],function(e,i){var n=this._convertResultToObject(i,["value"]);t(n)}.bind(this))}.bind(this))},createFile:function(e){var t=this._getGuid();this._db.transaction(function(i){i.executeSql("CREATE TABLE IF NOT EXISTS `"+t+"` "+"(id INTEGER PRIMARY KEY, type VARCHAR(255), value TEXT)",[]);var n={id:t,name:"Untitled File",modifiedTime:Date.now()};i.executeSql("INSERT INTO `files` VALUES (?, ?, ?)",[n.id,n.name,n.modifiedTime],this._success,this._error),e(n)})},renameFile:function(e,t){this._db.transaction(function(i){i.executeSql("UPDATE `files` SET name = ? WHERE id = ?",[t,e],this._success,this._error)})},deleteFile:function(e){this._db.transaction(function(t){t.executeSql("DELETE FROM `files` WHERE id = ?",[e],this._success,this._error),t.executeSql("DROP TABLE `"+e+"`",[],this._success,this._error)})},addAction:function(e,t){this._db.transaction(function(i){i.executeSql("INSERT INTO `"+e+"` (id, type, value) VALUES (?, ?, ?)",[t.id,t.type,JSON.stringify(t.value)],this._success,this._error)})},removeAction:function(e,t){this._db.transaction(function(i){i.executeSql("DELETE FROM `"+e+"` WHERE id = ?",[t],this._success,this._error)})},updateFileModified:function(e,t){this._db.transaction(function(i){i.executeSql("UPDATE `files` SET modifiedTime = ? WHERE id = ?",[t,e],this._success,this._error)})},clearAll:function(){this.getFiles(function(e){for(var t=0;t<e.length;t++)this.deleteFile(e[t].id)}.bind(this))},_databaseCreated:function(){this._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS files (id VARCHAR(255) PRIMARY KEY, name VARCHAR(255), modifiedTime INTEGER)")})},_convertResultToObject:function(e,t){for(var i=e.rows,n=new Array(i.length),s=0;s<i.length;s++){var o=i.item(s),r={};n[s]=r;for(var a in o)r[a]=o[a];if(t)for(var l=0;l<t.length;l++){var c=n[s][t[l]];if(c){var u=JSON.parse(c);n[s][t[l]]=u}}}return n},_success:function(){},_error:function(e){console.error("Error with WebSQL",e)}});return t}),n("data",["class","dataBacking/indexedDBBacking","dataBacking/webSQLBacking","event"],function(e,t,i,n){var s=e.extend({_backing:null,init:function(){var e=window.indexedDB;e?(console.log("Using IndexedDB as data store"),this._backing=new t):(console.log("Using WebSQL as data store"),this._backing=new i),n.addListener("fileModified",this._fileModified.bind(this))},getFiles:function(e){this._backing.getFiles(e)},getFile:function(e,t){this._backing.getFile(e,t)},getFileActions:function(e,t){this._backing.getFileActions(e,t)},createFile:function(e){this._backing.createFile(e)},renameFile:function(e,t){this._backing.renameFile(e,t)},deleteFile:function(e){this._backing.deleteFile(e)},addAction:function(e,t){this._backing.addAction(e,t)},removeAction:function(e,t){this._backing.removeAction(e,t)},clearAll:function(){this._backing.clearAll()},_fileModified:function(e){this._backing.updateFileModified(e.fileId,e.timestamp)},localFileSettings:function(e,t){return t&&(localStorage[e]=JSON.stringify(t)),localStorage[e]||(localStorage[e]=JSON.stringify({offsetX:0,offsetY:0,scale:1,color:"#000",tools:{point:"pencil",gesture:null,scroll:"pan"}})),JSON.parse(localStorage[e])}}),o=new s;return window.data=o,o}),n("templates/fileList",[],function(){function e(){var e='<li class="file-info"><div class="thumbnail-wrapper"><canvas class="thumbnail"></canvas><div class="overlay"><span class="file-name"></span><span class="delete icon-close" data-action="delete"></span></div></div></li',t=document.createElement("div");return t.innerHTML=e,t.firstChild}return e}),n("components/drawCanvas",["class","helpers"],function(e,t){var i=e.extend({_canvas:null,_ctx:null,_settings:null,_tempCanvas:null,_tempCtx:null,init:function(e,t){this._canvas=e,this._ctx=e.getContext("2d"),this._settings=t,this._backCanvas=document.createElement("canvas"),this._backCtx=this._backCanvas.getContext("2d"),this._tempCanvas=document.createElement("canvas"),this._tempCtx=this._tempCanvas.getContext("2d")},doAll:function(e){this._backCanvas.width=this._canvas.width,this._backCanvas.height=this._canvas.height,this._clearCanvas(this._backCanvas,this._backCtx),this._clearCanvas(this._tempCanvas,this._tempCtx);for(var t=0;t<e.length;t++){var i=e[t];this._doAction(this._backCtx,i)}},doTemporaryAction:function(e){this._tempCanvas.width=this._canvas.width,this._tempCanvas.height=this._canvas.height,this._clearCanvas(this._tempCanvas,this._tempCtx),this._doAction(this._tempCtx,e)},addAction:function(e){this._doAction(this._backCtx,e),this._clearCanvas(this._tempCanvas,this._tempCtx)},clear:function(){this._clearCanvas(this._canvas,this._ctx)},_clearCanvas:function(e,i){i.setTransform(this._settings.scale,0,0,this._settings.scale,this._settings.offsetX,this._settings.offsetY);var n=t.screenToWorld(this._settings,0,0),s=t.screenToWorld(this._settings,e.width,e.height);i.clearRect(n.x,n.y,s.x-n.x,s.y-n.y)},render:function(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.drawImage(this._backCanvas,0,0,this._backCanvas.width,this._backCanvas.height),this._ctx.drawImage(this._tempCanvas,0,0,this._tempCanvas.width,this._tempCanvas.height)},_doAction:function(e,t){"stroke"==t.type&&this._drawStroke(e,t.value)},updateSettings:function(e){this._settings=e},_drawStroke:function(e,i){if(!(i.points.length<2)){var n=[],s=i.points;n=i.controlPoints?i.controlPoints:t.getCurveControlPoints(s);var o=s[0],r=i.width;i.lockWidth&&(r/=this._settings.scale),e.lineWidth=r,e.strokeStyle=i.color,e.beginPath(),e.moveTo(o.x,o.y);for(var a=1;a<s.length;a++){o=s[a];var l=n[a-1][0],c=n[a-1][1];e.bezierCurveTo(l[0],l[1],c[0],c[1],o[0],o[1])}e.lineCap="round",e.stroke()}}});return i}),n("components/manipulateCanvas",["components/drawCanvas","helpers"],function(e,t){var i=e.extend({zoom:function(e,i,n){if(this._settings.scale+n<.001||this._settings.scale+n>2e4)return!1;var s=t.screenToWorld(this._settings,e,i);this._settings.scale+=n;var o=t.worldToScreen(this._settings,s.x,s.y),r={x:e-o.x,y:i-o.y};return this._settings.offsetX+=r.x,this._settings.offsetY+=r.y,!0},pan:function(e,t){return this._settings.offsetX+=e,this._settings.offsetY+=t,!0},panTo:function(e,t){this._settings.offsetX=e,this._settings.offsetY=t}});return i}),n("components/thumbnail",["class","helpers","data","components/manipulateCanvas"],function(e,t,i,n){var s=e.extend({_canvas:null,init:function(e){this._canvas=e},render:function(e){data.getFileActions(e.id,function(i){var s=data.localFileSettings(e.id),o=new n(this._canvas,s),r={x:window.innerWidth/2,y:window.innerHeight/2},a=t.screenToWorld(s,r.x,r.y),l=Math.min(this._canvas.width/window.innerWidth,this._canvas.height/window.innerHeight),c=s.scale*l-s.scale;o.zoom(0,0,c);var u={x:this._canvas.width/2,y:this._canvas.height/2},h=t.worldToScreen(s,a.x,a.y),d={x:u.x-h.x,y:u.y-h.y};o.pan(d.x,d.y),o.doAll(i),o.render()}.bind(this))}});return s}),n("sections/fileList",["section","tapHandler","event","globals","helpers","data","templates/fileList","components/thumbnail"],function(e,t,i,n,s,o,r,a){var l=e.extend({id:"files-list-container",_filesPane:null,_fileListElement:null,_files:null,_fileOrder:null,_resizeTimeout:null,init:function(e){this._super(),this._filesPane=e,this._fileListElement=document.getElementById("files-list"),this._files={},this._fileOrder=[],this._resizeAndRender=this._resizeAndRender.bind(this),this._actuallyResizeAndRender=this._actuallyResizeAndRender.bind(this),n.isPhone()&&(this._fileListElement.innerHTML=""),o.getFiles(function(e){for(var t=0;t<e.length;t++){var i=e[t];this._files[i.id]=i,this._fileOrder[t]=i.id;var n=this._newFileWrapper(i);this._fileListElement.appendChild(n)}this._actuallyResizeAndRender()}.bind(this)),this.element.addEventListener("wheel",function(e){e.stopPropagation()}),new t(document.getElementById("file-create"),{tap:this._newDoc.bind(this)}),new t(this._fileListElement,{tap:this._docSelected.bind(this)}),i.addListener("fileModified",this._fileModified.bind(this)),i.addListener("fileRenamed",this._fileRenamed.bind(this)),window.addEventListener("resize",this._resizeAndRender)},show:function(e){if(e){var t=this._files[e.id];t||console.error("We somehow came from a file that doesn't exist"),t.thumbnail.render(t.file)}},_newFileWrapper:function(e){var t=new r,i=t.getElementsByClassName("thumbnail")[0],n=t.getElementsByClassName("file-name")[0],s=new a(i);return n.innerText=e.name,t.fileId=e.id,this._files[e.id]={element:t,file:e,canvas:i,thumbnail:s},t},_resizeAndRender:function(){this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._actuallyResizeAndRender.bind(this),500)},_actuallyResizeAndRender:function(){for(var e in this._files){var t=this._files[e];this._resizeAndRenderFile(t)}},_resizeAndRenderFile:function(e){var t=e.canvas.parentElement;e.canvas.width=t.offsetWidth,e.canvas.height=t.offsetHeight,e.thumbnail.render(e.file)},_newDoc:function(){data.createFile(function(e){var t=this._newFileWrapper(e);this._fileOrder.unshift(e.id),this._fileListElement.insertBefore(t,this._fileListElement.children[1]),this._actuallyResizeAndRender()}.bind(this))},_docSelected:function(e){var t=e.target,i=s.parentEleWithClassname(t,"file-info");
if(i)if(i.classList.contains("create"))this._newDoc();else{if(t.dataset.action&&"delete"==t.dataset.action){var n=this._files[i.fileId];return this._fileListElement.removeChild(n.element),delete this._files[i.fileId],data.deleteFile(i.fileId),this._actuallyResizeAndRender(),void 0}this._filesPane.setPane("draw",this._files[i.fileId].file)}},_fileModified:function(e){for(var t=this._fileOrder.indexOf(e.fileId),i=t;i<this._files.length-1;i++)this._fileOrder[i]=this._fileOrder[i+1];this._fileOrder.length=this._fileOrder.length-1,this._fileOrder.unshift(e.fileId);var n=this._files[e.fileId].element;this._fileListElement.removeChild(n),this._fileListElement.insertBefore(n,this._fileListElement.children[1]),this._actuallyResizeAndRender()},_fileRenamed:function(e){this._files[e.fileId].name=e.name;var t=this._files[e.fileId].element,i=t.getElementsByClassName("file-name")[0];i.innerText=e.name}});return l}),n("sections/draw",["section","globals","event","helpers","tapHandler","platform","db","data","components/manipulateCanvas"],function(e,t,i,n,s,o,r,a,l){var c=e.extend({id:"draw",_filesPane:null,_manipulateCanvas:null,_canvas:null,_fileInfo:null,_settings:null,_actions:null,_currentAction:null,_updateAll:!0,_updateCurrentAction:!1,_shouldRender:!1,_saveSettingsTimeout:null,_redoStack:null,_canvasTapHandler:null,_toolTapHandler:null,_fileNameElement:null,_overlay:null,init:function(e){this._super(),this._filesPane=e,this._canvas=document.getElementById("canvas"),this._resize=this._resize.bind(this),this.element.addEventListener("touchmove",function(e){e.preventDefault()}),this._canvasTapHandler=new s(this.element,{start:this._start.bind(this),move:this._move.bind(this),end:this._end.bind(this),gesture:this._gesture.bind(this)}),this._toolTapHandler=new s(document.getElementById("tools"),{tap:this._toolChanged.bind(this),start:this._toolStart.bind(this),end:this._toolEnd.bind(this)}),new s(document.getElementById("menu"),{start:function(e){e.stopPropagation()},tap:this._menuTapped.bind(this)}),new s(document.getElementById("fileName"),{start:function(e){e.stopPropagation()}}),new s(document.getElementById("options"),{start:function(e){e.stopPropagation()},tap:this._menuTapped.bind(this)}),new s(document.getElementById("colorPicker"),{start:function(e){e.stopPropagation()},tap:this._colorPicked.bind(this)}),this._overlay=document.getElementById("draw-overlay"),this._overlay.addEventListener("mousedown",this._hideModal.bind(this)),this._overlay.addEventListener("touchstart",this._hideModal.bind(this)),this.element.addEventListener(o.mouseWheel,this._mouseWheel.bind(this)),this.element.addEventListener("keydown",this._keyDown.bind(this)),this._fileNameElement=document.getElementById("fileName"),this._fileNameElement.addEventListener("keydown",this._fileNameKeyDown.bind(this)),this._fileNameElement.addEventListener("blur",this._fileNameBlur.bind(this))},show:function(e){this._actions=[],this._redoStack=[],data.getFile(e.id,function(e){this._fileInfo=e,this._fileNameElement.value=this._fileInfo.name}.bind(this)),data.getFileActions(e.id,function(t){this._actions=t,this._updateAll=!0,this._settings=data.localFileSettings(e.id),this._manipulateCanvas=new l(this._canvas,this._settings),this._setDisabledUndoRedo(),this._setActiveTool(),this._shouldRender=!0,this._redraw(),document.getElementById("chosenColorSwatch").style.backgroundColor=this._settings.color}.bind(this)),this._resize(),setTimeout(function(){canvas.focus()}.bind(this),400),window.addEventListener("resize",this._resize)},hide:function(){this._shouldRender=!1,window.removeEventListener("resize",this._resize)},_resize:function(){this._canvas.width=window.innerWidth,this._canvas.height=window.innerHeight,this._updateAll=!0},_zoom:function(e,t,i){this._manipulateCanvas.zoom(e,t,i)&&(this._saveSettings(),this._updateAll=!0)},_pan:function(e,t){this._manipulateCanvas.pan(e,t)&&(this._saveSettings(),this._updateAll=!0)},_mouseWheel:function(e){var t=isNaN(e.deltaX)?e.wheelDeltaX/5:-e.deltaX,i=isNaN(e.deltaY)?e.wheelDeltaY/5:-e.deltaY;"pan"==this._settings.tools.scroll?this._pan(t,i):"zoom"==this._settings.tools.scroll&&0!=i&&this._zoom(e.clientX,e.clientY,i/100*this._settings.scale)},_start:function(e){var t=this._settings.tools.gesture||this._settings.tools.point;if(1==e.button&&(t="pan"),"pan"!=t){var i=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop);this._currentAction&&console.error("Current action isn't null!"),this._currentAction={type:"stroke",value:{points:[[i.x,i.y]],width:2,lockWidth:!0,color:this._settings.color}},this._redoStack=[],"eraser"==t?(this._currentAction.value.width=30/this._settings.scale,this._currentAction.value.color="#ffffff",this._currentAction.value.lockWidth=!1):"pencil"==this._settings.tools.point,this._setDisabledUndoRedo()}},_move:function(e){var t=this._settings.tools.gesture||this._settings.tools.point;if(1==e.button&&(t="pan"),"pan"==t)this._pan(e.xFromLast,e.yFromLast);else if("pencil"==t||"eraser"==t){if(!this._currentAction)return;var i=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop),s=this._currentAction.value,o=s.points,r=o[o.length-1],a=Math.sqrt((r[0]-i[0])*(r[0]-i[0])+(r[1]-i[1])*(r[1]-i[1]));if(.001>a)return;s.points.push([i.x,i.y]),this._updateCurrentAction=!0}},_end:function(){var e=this._settings.tools.gesture||this._settings.tools.point;if("pencil"==e||"eraser"==e){if(!this._currentAction)return;var t=this._currentAction;this._currentAction=null;var i=t.value;if(i.points.length<2)return;var s=n.getCurveControlPoints(i.points);i.controlPoints=s,this._updateCurrentAction=!0,this._saveAction(t),this._setDisabledUndoRedo()}},_saveAction:function(e){e.id=this._actions.length+1,this._actions.push(e),this._manipulateCanvas.addAction(e),data.addAction(this._fileInfo.id,e),i.trigger("fileModified",{fileId:this._fileInfo.id,timestamp:Date.now()}),this._updateAll=!0},_gesture:function(e){this._pan(e.xFromLast,e.yFromLast),this._zoom(e.x,e.y,e.scaleFromLast*this._settings.scale)},_redraw:function(){this._shouldRender&&(this._updateAll&&this._manipulateCanvas.doAll(this._actions),this._updateCurrentAction&&this._currentAction&&this._manipulateCanvas.doTemporaryAction(this._currentAction),(this._updateAll||this._updateCurrentAction)&&(this._manipulateCanvas.render(),this._updateAll=!1,this._updateCurrentAction=!1),requestAnimationFrame(this._redraw.bind(this)))},_menuTapped:function(e){if("LI"==e.target.tagName){var t=e.target.dataset.action;if("back"==t)this._filesPane.setPane("list",this._fileInfo);else if("rename"==t)e.target.focus();else if("export"==t){var i=this._canvas.toDataURL();window.open(i)}}},_showModal:function(e){var t=document.getElementById(e);return t?(this._overlay.currentModal=e,this._overlay.style.display="block",setTimeout(function(){t.classList.add("visible")},0),void 0):(console.error("No modal with that id"),void 0)},_hideModal:function(e){if(!e||e.target==this._overlay){if(this._overlay.currentModal){var t=document.getElementById(this._overlay.currentModal);t.classList.remove("visible"),this._overlay.currentModal=""}this._overlay.style.display=""}},_colorPicked:function(e){if(parent=n.parentEleWithClassname(e.target,"swatch")){var t=parent.style.backgroundColor;this._settings.color=t,this._saveSettings(),document.getElementById("chosenColorSwatch").style.backgroundColor=t,this._hideModal()}e.stopPropagation()},_toolStart:function(e){var t=e.target.dataset.tool;e.target.dataset.action,"LI"==e.target.tagName&&t&&("pan"==t||"eraser"==t||"pencil"==t)&&(this._settings.tools.gesture=t,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!0),this._toolTapHandler.ignoreGestures(!0)),e.stopPropagation(),e.preventDefault()},_toolEnd:function(e){if(e){var t=e.target.dataset.tool;"LI"==e.target.tagName&&t&&("pan"==t||"eraser"==t||"pencil"==t)&&(this._settings.tools.gesture=null,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!1),this._toolTapHandler.ignoreGestures(!1))}},_toolChanged:function(e){var i=n.parentEleWithClassname(e.target,"toolitem");if(i&&"LI"==i.tagName){var s=i.dataset.action,o=i.dataset.tool;o?("pencil"==o?this._settings.tools.point="pencil":"eraser"==o?this._settings.tools.point="eraser":"pan"==o?t.isComputer()?this._settings.tools.scroll="pan":this._settings.tools.point="pan":"zoom"==o&&(this._settings.tools.scroll="zoom"),this._setActiveTool(),this._saveSettings()):s&&("undo"==s?this._undo():"redo"==s&&this._redo(),"color"==s&&(this._showModal("colorPicker"),e.preventDefault(),e.stopImmediatePropagation()))}},_setDisabledUndoRedo:function(){var e=document.getElementById("undo-tool"),t=document.getElementById("redo-tool");this._actions.length?e.classList.remove("disabled"):e.classList.add("disabled"),this._redoStack.length?t.classList.remove("disabled"):t.classList.add("disabled")},_setActiveTool:function(){function e(e){var t=i.dataset["active"+e];if(t){var n=document.getElementById(t);n.classList.remove("active-"+e)}var s=this._settings.tools[e];if(s){var o=s+"-tool",r=document.getElementById(o);r.classList.add("active-"+e),i.dataset["active"+e]=o}else delete i.dataset["active"+e]}var i=document.getElementById("tools");e=e.bind(this),e("point"),t.isComputer()&&e("scroll")},_keyDown:function(e){var i=String.fromCharCode(e.keyCode);t.isMac()&&e.metaKey&&e.shiftKey&&"Z"==i||t.isPC()&&e.ctrlKey&&"Y"==i?this._redoStack.length>0&&this._redo():(t.isMac()&&e.metaKey||t.isPC()&&e.ctrlKey)&&"Z"==i?(e.preventDefault(),this._undo()):"Z"==i?(this._settings.tools.scroll="zoom",this._setActiveTool()):"P"==i&&(this._settings.tools.scroll="pan",this._setActiveTool())},_undo:function(){if(this._actions.length>0){var e=this._actions.pop(),t={};for(var i in e)"id"!=i&&(t[i]=e[i]);this._redoStack.push(t),data.removeAction(this._fileInfo.id,e.id),this._manipulateCanvas.doAll(this._actions),this._updateAll=!0,this._setDisabledUndoRedo()}},_redo:function(){if(this._redoStack.length>0){var e=this._redoStack.pop();this._saveAction(e),this._setDisabledUndoRedo()}},_fileNameKeyDown:function(e){13==e.keyCode&&this._fileNameElement.blur()},_fileNameBlur:function(e){var t=e.target.value;data.renameFile(this._fileInfo.id,t),i.trigger("fileRenamed",{fileId:this._fileInfo.id,name:t})},_saveSettings:function(){this._saveSettingsTimeout&&clearTimeout(this._saveSettingsTimeout),this._saveSettingsTimeout=setTimeout(function(){data.localFileSettings(this._fileInfo.id,this._settings),this._saveSettingsTimeout=null}.bind(this),100)}});return c}),n("managers/files",["section","event","platform","sections/fileList","sections/draw"],function(e,t,i,n,s){var o=e.extend({id:"files",_paneWrapper:null,_screenWidth:0,_defaultSettings:{},panes:null,currentPaneName:null,init:function(){this._super(),this._defaultSettings={title:{text:"Photos"}},this._screenWidth=window.innerWidth,this._paneWrapper=document.getElementById("files-pane-wrapper"),this._windowResized=this._windowResized.bind(this),this._finishedSliding=this._finishedSliding.bind(this),this._paneWrapper.addEventListener(i.transitionEnd,this._finishedSliding),this.panes={},this.panes.list={offsetX:0,pane:new n(this)},this.panes.draw={offsetX:this._screenWidth,pane:new s(this)},this.panes.draw.pane.element.style[i.transform]="translate("+this._screenWidth+"px, 0px)";var e={pane:"list",details:null};localStorage.filesPane&&(e=JSON.parse(localStorage.filesPane)),this.setPane(e.pane,e.details),this._redoOffsets(),window.files=this},show:function(){window.addEventListener("resize",this._windowResized)},hide:function(){window.removeEventListener("resize",this._windowResized)},setPane:function(e,t){if(this.currentPaneName!=e){var n=null;if(this.currentPaneName){var n=this.panes[this.currentPaneName].pane;n.hide&&n.hide(),n.afterHide()}n=this.panes[e].pane,n.show&&n.show(t),n.afterShow(),this.currentPaneName=e;var s=this.panes[e],o="translate("+-1*s.offsetX+"px, 0px)";this._paneWrapper.style[i.transform]!=o&&(this._paneWrapper.classList.add("ani4"),this._paneWrapper.style[i.transform]=o),"list"==e?delete localStorage.filesPane:localStorage.filesPane=JSON.stringify({pane:e,details:t})}},_finishedSliding:function(e){e.target==this._paneWrapper&&(this._paneWrapper.classList.remove("ani4"),this._redoOffsets())},_windowResized:function(){this._redoOffsets()},_redoOffsets:function(){window.current=this,this._screenWidth=window.innerWidth;var e=0;for(var t in this.panes){if(this.currentPaneName==t)break;e++}var n=-1*e*this._screenWidth;for(var t in this.panes)this.panes[t].offsetX=n,this.panes[t].pane.element.style[i.transform]="translate("+n+"px, 0px)",n+=this._screenWidth;this._paneWrapper.style[i.transform]=""}});return o}),n("sections/main",["section","event","managers/files"],function(e,t,i){var n=e.extend({id:"main-container",mainContent:null,panes:null,currentPane:"",init:function(){this._super(),this.mainContent=document.getElementById("main-content"),this.panes={},this.panes.files=new i,t.addListener("logout",this._logout.bind(this))},show:function(){localStorage.currentPane?this.setPane(localStorage.currentPane):this.setPane("files")},setPane:function(e){if(this.currentPane!=e){var i=null;if(this.currentPane){var i=this.panes[this.currentPane];i.hide&&i.hide(),i.afterHide()}i=this.panes[e],i.show&&i.show(),i.afterShow(),this.currentPane=e,localStorage.currentPane=e,t.trigger("paneChanged",{pane:i})}},_logout:function(){delete localStorage.currentPane}});return n}),n("managers/login",["event","sections/login","sections/main"],function(e,t,i){function n(){this.init()}return n.prototype={pages:null,currentPage:"",init:function(){this.pages={},e.addListener("login",this._login.bind(this)),e.addListener("logout",this._logout.bind(this)),this.pages.login=new t,this.pages.main=new i,localStorage.loggedIn="true","true"==localStorage.loggedIn?this.setPage("main"):this.setPage("login")},setPage:function(e){var t=null;if(this.currentPage){var t=this.pages[this.currentPage];t.hide&&t.hide(),t.afterHide()}t=this.pages[e],t.show&&t.show(),t.afterShow(),this.currentPage=e},_login:function(){localStorage.loggedIn=!0,this.setPage("main")},_logout:function(){localStorage.loggedIn=!1,this.setPage("login")}},n}),"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,!1),n("main",function(){})}();