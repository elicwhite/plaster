!function(){function a(){window.log=console.log.bind(console),window.addEventListener("wheel",function(a){a.preventDefault()}),c(["event","globals","helpers","migrate","managers/login","gauth"],function(a,b,c,d,e){function f(){document.body.style.height=window.innerHeight+"px"}d.run().then(function(){b.setHTMLDevices();new e}.bind(this)),window.addEventListener("resize",function(){window.scroll(0,0),f()}),f()})}var b,c,d;!function(a){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(b,c){return function(){return n.apply(a,v.call(arguments,0).concat([b,c]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(b){if(e(r,b)){var c=r[b];delete r[b],t[b]=!0,m.apply(a,c)}if(!e(q,b)&&!e(t,b))throw new Error("No "+b);return q[b]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(b,c,d,f){var h,k,l,m,n,s,u=[];if(f=f||b,"function"==typeof d){for(c=!c.length&&d.length?["require","exports","module"]:c,n=0;n<c.length;n+=1)if(m=o(c[n],f),k=m.f,"require"===k)u[n]=p.require(b);else if("exports"===k)u[n]=p.exports(b),s=!0;else if("module"===k)h=u[n]=p.module(b);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(b+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=d.apply(q[b],u),b&&(h&&h.exports!==a&&h.exports!==q[b]?q[b]=h.exports:l===a&&s||(q[b]=l))}else b&&(q[b]=d)},b=c=n=function(b,c,d,e,f){return"string"==typeof b?p[b]?p[b](c):j(o(b,c).f):(b.splice||(s=b,c.splice?(b=c,c=d,d=null):b=a),c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},b._defined=q,d=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},d.amd={jQuery:!0}}(),d("almond",function(){}),d("event",[],function(){function a(){this.init()}return a.prototype={listeners:null,init:function(){this.listeners=[]},addListener:function(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)},removeListener:function(a,b){if(!this.listeners[a])return!1;var c=this.listeners[a].indexOf(b);return-1!==c?(delete this.listeners[a][c],!0):!1},trigger:function(a,b){return this.listeners[a]?(this.listeners[a].forEach(function(a){a(b)}),!0):!1}},new a}),d("globals",["event"],function(){var a=function(){this.init()};return a.prototype={init:function(){},isiOS:function(){return this.hasDeviceType("iOS")},isPC:function(){return this.hasDeviceType("PC")},isMac:function(){return this.hasDeviceType("Mac")},isComputer:function(){return this.hasDeviceType("computer")},isPhone:function(){return this.hasDeviceType("phone")},isTablet:function(){return this.hasDeviceType("tablet")},isMobile:function(){return this.isPhone()||this.isTablet()},hasDeviceType:function(a){return-1!==this.getDeviceType().indexOf(a)},getDeviceType:function(){var a=[],b=navigator.userAgent;return b.match(/iPad/g)?(a.push("iOS"),a.push("iPad"),a.push("tablet")):b.match(/iPhone/g)?(a.push("iOS"),a.push("iPhone"),a.push("phone")):b.match(/Mac/g)?(a.push("Mac"),a.push("computer")):b.match(/Android/g)?(a.push("Android"),a.push(b.match(/Mobile/g)?"phone":"tablet")):(a.push("PC"),a.push("computer")),localStorage.deviceType=JSON.stringify(a),a},setHTMLDevices:function(){var a=this.getDeviceType(),b=document.body;b.className=a.join(" ")},getStylesheet:function(){for(var a=0,b=0;b<document.styleSheets.length;b++)if(document.styleSheets[b].href&&document.styleSheets[b].href.indexOf("total.css")){a=b;break}return document.styleSheets[a]},getStylesheetRules:function(){var a=this.getStylesheet();if(!a)return{};var b=a.cssRules||a.rules;return b},getCSSVars:function(){var a=this.getStylesheetRules(),b=a[a.length-1],c=this.removeQuotes(b.style.content);return JSON.parse(c)},removeQuotes:function(a){return("string"==typeof a||a instanceof String)&&(a=a.replace(/^['"]+|\s+|\\|(;\s?})+|['"]$/g,"")),a}},new a}),d("helpers",[],function(){return{parentEleWithClassname:function(a,b){return null!=a&&a.classList?a.classList.contains(b)?a:this.parentEleWithClassname(a.parentNode,b):!1},parentEleIsElement:function(a,b){return null==a?!1:a==b?a:this.parentEleIsElement(a.parentNode,b)},screenToWorld:function(a,b,c){return{x:(b-a.offsetX)/a.scale,y:(c-a.offsetY)/a.scale}},worldToScreen:function(a,b,c){return{x:b*a.scale+a.offsetX,y:c*a.scale+a.offsetY}},getGuid:function(){return"T^"+Date.now()+Math.round(1e6*Math.random())},isLocalGuid:function(a){return 0===a.indexOf("T^")},clone:function(a){var b={};for(var c in a)b[c]=a[c];return b},cloneArray:function(a){for(var b=a.slice(0),c=0;c<a.length;c++)"object"==typeof a[c]&&(b[c]=this.cloneArray(a[c]));return b}}}),d("class",[],function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;return this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d},this.Class}),function(a){function b(a,b,d){var j=0,k=[0],l="",m=null,l=d||"UTF8";if("UTF8"!==l&&"UTF16"!==l)throw"encoding must be UTF8 or UTF16";if("HEX"===b){if(0!==a.length%2)throw"srcString of HEX type must be in byte increments";m=e(a),j=m.binLen,k=m.value}else if("ASCII"===b||"TEXT"===b)m=c(a,l),j=m.binLen,k=m.value;else{if("B64"!==b)throw"inputFormat must be HEX, TEXT, ASCII, or B64";m=f(a),j=m.binLen,k=m.value}this.getHash=function(a,b,c,d){var e,f=null,l=k.slice(),m=j;if(3===arguments.length?"number"!=typeof c&&(d=c,c=1):2===arguments.length&&(c=1),c!==parseInt(c,10)||1>c)throw"numRounds must a integer >= 1";switch(b){case"HEX":f=g;break;case"B64":f=h;break;default:throw"format must be HEX or B64"}if("SHA-224"===a)for(e=0;c>e;e++)l=t(l,m,a),m=224;else{if("SHA-256"!==a)throw"Chosen SHA variant is not supported";for(e=0;c>e;e++)l=t(l,m,a),m=256}return f(l,i(d))},this.getHMAC=function(a,b,d,m,n){var o,p,q,r,s=[],u=[];switch(o=null,m){case"HEX":m=g;break;case"B64":m=h;break;default:throw"outputFormat must be HEX or B64"}if("SHA-224"===d)p=64,r=224;else{if("SHA-256"!==d)throw"Chosen SHA variant is not supported";p=64,r=256}if("HEX"===b)o=e(a),q=o.binLen,o=o.value;else if("ASCII"===b||"TEXT"===b)o=c(a,l),q=o.binLen,o=o.value;else{if("B64"!==b)throw"inputFormat must be HEX, TEXT, ASCII, or B64";o=f(a),q=o.binLen,o=o.value}for(a=8*p,b=p/4-1,q/8>p?(o=t(o,q,d),o[b]&=4294967040):p>q/8&&(o[b]&=4294967040),p=0;b>=p;p+=1)s[p]=909522486^o[p],u[p]=1549556828^o[p];return d=t(u.concat(t(s.concat(k),a+j,d)),a+r,d),m(d,i(n))}}function c(a,b){var c,d,e=[],f=[],g=0;if("UTF8"===b)for(d=0;d<a.length;d+=1)for(c=a.charCodeAt(d),f=[],c>2048?(f[0]=224|(61440&c)>>>12,f[1]=128|(4032&c)>>>6,f[2]=128|63&c):c>128?(f[0]=192|(1984&c)>>>6,f[1]=128|63&c):f[0]=c,c=0;c<f.length;c+=1)e[g>>>2]|=f[c]<<24-g%4*8,g+=1;else if("UTF16"===b)for(d=0;d<a.length;d+=1)e[g>>>2]|=a.charCodeAt(d)<<16-g%4*8,g+=2;return{value:e,binLen:8*g}}function e(a){var b,c,d=[],e=a.length;if(0!==e%2)throw"String of HEX type must be in byte increments";for(b=0;e>b;b+=2){if(c=parseInt(a.substr(b,2),16),isNaN(c))throw"String of HEX type contains invalid characters";d[b>>>3]|=c<<24-b%8*4}return{value:d,binLen:4*e}}function f(a){var b,c,d,e,f,g=[],h=0;if(-1===a.search(/^[a-zA-Z0-9=+\/]+$/))throw"Invalid character in base-64 string";if(b=a.indexOf("="),a=a.replace(/\=/g,""),-1!==b&&b<a.length)throw"Invalid '=' found in base-64 string";for(c=0;c<a.length;c+=4){for(f=a.substr(c,4),d=e=0;d<f.length;d+=1)b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(f[d]),e|=b<<18-6*d;for(d=0;d<f.length-1;d+=1)g[h>>2]|=(e>>>16-8*d&255)<<24-h%4*8,h+=1}return{value:g,binLen:8*h}}function g(a,b){var c,d,e="",f=4*a.length;for(c=0;f>c;c+=1)d=a[c>>>2]>>>8*(3-c%4),e+="0123456789abcdef".charAt(d>>>4&15)+"0123456789abcdef".charAt(15&d);return b.outputUpper?e.toUpperCase():e}function h(a,b){var c,d,e,f="",g=4*a.length;for(c=0;g>c;c+=3)for(e=(a[c>>>2]>>>8*(3-c%4)&255)<<16|(a[c+1>>>2]>>>8*(3-(c+1)%4)&255)<<8|a[c+2>>>2]>>>8*(3-(c+2)%4)&255,d=0;4>d;d+=1)f=8*c+6*d<=32*a.length?f+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6*(3-d)&63):f+b.b64Pad;return f}function i(a){var b={outputUpper:!1,b64Pad:"="};try{a.hasOwnProperty("outputUpper")&&(b.outputUpper=a.outputUpper),a.hasOwnProperty("b64Pad")&&(b.b64Pad=a.b64Pad)}catch(c){}if("boolean"!=typeof b.outputUpper)throw"Invalid outputUpper formatting option";if("string"!=typeof b.b64Pad)throw"Invalid b64Pad formatting option";return b}function j(a,b){return a>>>b|a<<32-b}function k(a,b,c){return a&b^~a&c}function l(a,b,c){return a&b^a&c^b&c}function m(a){return j(a,2)^j(a,13)^j(a,22)}function n(a){return j(a,6)^j(a,11)^j(a,25)}function o(a){return j(a,7)^j(a,18)^a>>>3}function p(a){return j(a,17)^j(a,19)^a>>>10}function q(a,b){var c=(65535&a)+(65535&b);return((a>>>16)+(b>>>16)+(c>>>16)&65535)<<16|65535&c}function r(a,b,c,d){var e=(65535&a)+(65535&b)+(65535&c)+(65535&d);return((a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)&65535)<<16|65535&e}function s(a,b,c,d,e){var f=(65535&a)+(65535&b)+(65535&c)+(65535&d)+(65535&e);return((a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)+(f>>>16)&65535)<<16|65535&f}function t(a,b,c){var d,e,f,g,h,i,j,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=[],N=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];if(v=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428],d=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],"SHA-224"!==c&&"SHA-256"!==c)throw"Unexpected error in SHA-2 implementation";for(w=64,z=16,A=1,K=Number,B=q,C=r,D=s,E=o,F=p,G=m,H=n,J=l,I=k,v="SHA-224"===c?v:d,a[b>>>5]|=128<<24-b%32,a[(b+65>>>9<<4)+15]=b,L=a.length,x=0;L>x;x+=z){for(b=v[0],d=v[1],e=v[2],f=v[3],g=v[4],h=v[5],i=v[6],j=v[7],y=0;w>y;y+=1)M[y]=16>y?new K(a[y*A+x],a[y*A+x+1]):C(F(M[y-2]),M[y-7],E(M[y-15]),M[y-16]),t=D(j,H(g),I(g,h,i),N[y],M[y]),u=B(G(b),J(b,d,e)),j=i,i=h,h=g,g=B(f,t),f=e,e=d,d=b,b=B(t,u);v[0]=B(b,v[0]),v[1]=B(d,v[1]),v[2]=B(e,v[2]),v[3]=B(f,v[3]),v[4]=B(g,v[4]),v[5]=B(h,v[5]),v[6]=B(i,v[6]),v[7]=B(j,v[7])}if("SHA-224"===c)a=[v[0],v[1],v[2],v[3],v[4],v[5],v[6]];else{if("SHA-256"!==c)throw"Unexpected error in SHA-2 implementation";a=v}return a}"function"==typeof d?d("vendor/sha256",[],function(){return b}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?module.exports=exports=b:exports=b:a.jsSHA=b}(this),d("gauth",["class","event","vendor/sha256"],function(a,b,c){var d=a.extend({CLIENT_ID:"450627732299-2d7jlo96ious5jmdmsd9t7hpclstf7ub.apps.googleusercontent.com",INSTALL_SCOPE:"https://www.googleapis.com/auth/drive.install",DRIVE_SCOPE:"https://www.googleapis.com/auth/drive",OPENID_SCOPE:"openid",_user:null,_authenticated:null,init:function(){this._authenticated=!1,b.addListener("onlineStatusChanged",function(a){a.online&&(console.log("Starting auth"),this.start())}.bind(this))},start:function(){this.authorize()},authorize:function(){gapi.auth.authorize({client_id:this.CLIENT_ID,scope:[this.INSTALL_SCOPE,this.DRIVE_SCOPE,this.OPENID_SCOPE],immediate:!0},this._handleAuthResult.bind(this))},_handleAuthResult:function(a){a&&!a.error?this._fetchUserId().then(function(){var b=new c(this._user.id,"TEXT").getHash("SHA-256","HEX");ga("set","&uid",b),ga("send","event","logged in"),this._setStatus(!0);var d=1e3*(parseInt(a.expires_in)-600);setTimeout(function(){console.log("Refreshing GAuth token"),this.authorize()}.bind(this),d)}.bind(this)):this._setStatus(!1)},authorizeWithPopup:function(){gapi.auth.authorize({client_id:this.CLIENT_ID,scope:[this.INSTALL_SCOPE,this.DRIVE_SCOPE,this.OPENID_SCOPE],immediate:!1},this._handleAuthResult.bind(this))},isAuthenticated:function(){return this._authenticated},_fetchUserId:function(){return new Promise(function(a){gapi.client.load("oauth2","v2",function(){gapi.client.oauth2.userinfo.get().execute(function(b){b.id&&(this._user=b.result),a()}.bind(this))}.bind(this))}.bind(this))},_setStatus:function(a){this._authenticated!=a&&(this._authenticated=a,b.trigger("authenticatedStatusChanged",{authenticated:a}))}});return new d}),d("online",["event"],function(a){var b=function(){this.init()};return b.prototype={_online:null,_script:null,_retryDelay:3e3,init:function(){this._script=document.getElementById("gapiScript"),window.addEventListener("online",this._onlineEvent.bind(this)),window.addEventListener("offline",this._offlineEvent.bind(this))},gapiLoaded:function(){console.log("Gapi loaded"),gapi.load("auth:client,drive-realtime,drive-share",function(){this._setStatus(!0)}.bind(this))},gapiLoadError:function(){console.warn("Failed to load gapi"),this._setStatus(!1),window.setTimeout(this._retryScript.bind(this),this._retryDelay)},isOnline:function(){return!!this._online},_retryScript:function(){navigator.onLine?(console.log("Retrying to load gapi"),this._reloadScript()):window.setTimeout(this._retryScript.bind(this),this._retryDelay)},_reloadScript:function(){var a=this._script.parentElement;a.removeChild(this._script);var b=document.createElement("script");b.onError=this._script.onError,b.async=this._script.async,b.id=this._script.id,b.type=this._script.type,b.src=this._script.src,this._script=b,a.insertBefore(this._script,a.children[0])},_onlineEvent:function(){window.gapi?this._setStatus(!0):this._reloadScript()},_offlineEvent:function(){this._setStatus(!1)},_setStatus:function(b){this._online!=b&&(this._online=b,a.trigger("onlineStatusChanged",{online:b}))},waitToComeOnline:function(b){return new Promise(function(c,d){function e(b){b.online&&(window.clearTimeout(g),a.removeListener("onlineStatusChanged",e),c())}function f(){a.removeListener("onlineStatusChanged",e),d()}if(this.isOnline())return void c();var g=null;a.addListener("onlineStatusChanged",e),g=window.setTimeout(f,b)}.bind(this))}},new b}),d("sequentialHelper",["event"],function(a){function b(){this.init()}return b.prototype={_runningActions:null,_openFiles:null,init:function(){this._runningActions={},this._openFiles=0,a.addListener("fileIdChanged",this._fileIdChanged.bind(this))},startLockedAction:function(a,b){this._runningActions[a]||(this._runningActions[a]=[],this._openFiles++);var c={promise:null,resolve:null,reject:null},d=new Promise(function(a,b){c.resolve=a,c.reject=b});return c.promise=d,"global"!=a&&this._runningActions.global&&!b||0!=this._runningActions[a].length||c.resolve(),this._runningActions[a].push(c),c.promise},endLockedAction:function(a){return this._runningActions[a].shift(),0==this._runningActions[a].length?(delete this._runningActions[a],this._openFiles--,void(1==this._openFiles&&this._runningActions.global&&this._runningActions.global[0].resolve())):void this._runningActions[a][0].resolve()},startGlobalAction:function(){return this.startLockedAction("global")},endGlobalAction:function(){this.endLockedAction("global");for(var a in this._runningActions)this._runningActions[a][0].resolve()},hasActions:function(){return 0!=this._openFiles},_fileIdChanged:function(a){this._runningActions[a.oldId]&&(this._runningActions[a.newId]=this._runningActions[a.oldId],delete this._runningActions[a.oldId])}},new b}),d("bezierCurve",[],function(){function a(){this.init()}return a.prototype={_rhs:null,_controlPoints:null,_tmp:null,_length:null,init:function(){this._length=0,this._rhs=[[],[]],this._controlPoints=[],this._tmp=[];for(var a=0;2e3>a;a++)this._tmp[a]=1,this._rhs[0][a]=1,this._rhs[1][a]=1},getCurveControlPoints:function(a){var b=a.length-1;if(this._length=b,this._controlPoints.length=b,1>b)return void console.error("Must have at least two knots");if(1==b){var c=[(2*a[0][0]+a[1][0])/3,(2*a[0][1]+a[1][1])/3],d=[2*c[0]-a[0][0],2*c[1]-a[0][1]];return[[c,d]]}this._rhs[0][0]=a[0][0]+2*a[1][0],this._rhs[1][0]=a[0][1]+2*a[1][1];for(var e=1;b-1>e;++e)this._rhs[0][e]=4*a[e][0]+2*a[e+1][0],this._rhs[1][e]=4*a[e][1]+2*a[e+1][1];this._rhs[0][b-1]=(8*a[b-1][0]+a[b][0])/2,this._rhs[1][b-1]=(8*a[b-1][1]+a[b][1])/2,this.getFirstControlPoints(this._rhs);for(var e=0;b>e;++e)"undefined"==typeof this._controlPoints[e]&&(this._controlPoints[e]=[new Array(2),new Array(2)]),this._controlPoints[e][0][0]=this._rhs[0][e],this._controlPoints[e][0][1]=this._rhs[1][e],b-1>e?(this._controlPoints[e][1][0]=2*a[e+1][0]-this._rhs[0][e+1],this._controlPoints[e][1][1]=2*a[e+1][1]-this._rhs[1][e+1]):(this._controlPoints[e][1][0]=(a[b][0]+this._rhs[0][b-1])/2,this._controlPoints[e][1][1]=(a[b][1]+this._rhs[1][b-1])/2);return this._controlPoints},getFirstControlPoints:function(){var a=this._length,b=2;this._rhs[0][0]/=b,this._rhs[1][0]/=b;for(var c=1;a>c;c++)this._tmp[c]=1/b,b=a-1>c?4-this._tmp[c]:3.5-this._tmp[c],this._rhs[0][c]-=this._rhs[0][c-1],this._rhs[0][c]/=b,this._rhs[1][c]-=this._rhs[1][c-1],this._rhs[1][c]/=b;for(var c=a-1;c>=0;c--)this._rhs[0][c-1]-=this._tmp[c]*this._rhs[0][c],this._rhs[1][c-1]-=this._tmp[c]*this._rhs[1][c]}},new a}),d("components/drawCanvas",["class","helpers","bezierCurve"],function(a,b){var c=a.extend({_canvas:null,_ctx:null,_settings:null,_backCanvas:null,_backCtx:null,_tempCanvas:null,_tempCtx:null,_useCurves:null,_raster:!1,_zooming:!1,_initialZoomSettings:null,init:function(a,b){this._canvas=a,this._ctx=a.getContext("2d"),this._settings=b,this._useCurves=!0,this._backCanvas=document.createElement("canvas"),this._backCtx=this._backCanvas.getContext("2d"),this._tempCanvas=document.createElement("canvas"),this._tempCtx=this._tempCanvas.getContext("2d")},useCurves:function(a){this._useCurves=a},rasterMode:function(a){this._raster=a,a||(this._initialZoomSettings=null)},doAll:function(a){this._backCanvas.width=this._canvas.width,this._backCanvas.height=this._canvas.height,this._clearCanvas(this._backCanvas,this._backCtx),this._clearCanvas(this._tempCanvas,this._tempCtx);for(var b=0;b<a.length;b++){var c=a[b];this._doAction(this._backCtx,c)}},doTemporaryAction:function(a){this._tempCanvas.width=this._canvas.width,this._tempCanvas.height=this._canvas.height,this._clearCanvas(this._tempCanvas,this._tempCtx),this._doAction(this._tempCtx,a)},addAction:function(a){this._doAction(this._backCtx,a),this._clearCanvas(this._tempCanvas,this._tempCtx)},clear:function(){this._clearCanvas(this._canvas,this._ctx)},_clearCanvas:function(a,c){c.setTransform(this._settings.scale,0,0,this._settings.scale,this._settings.offsetX,this._settings.offsetY);var d=b.screenToWorld(this._settings,0,0),e=b.screenToWorld(this._settings,a.width,a.height);c.clearRect(d.x,d.y,e.x-d.x,e.y-d.y)},render:function(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);var a=0,c=0,d=this._backCanvas.width,e=this._backCanvas.height;if(this._raster){var f=b.screenToWorld(this._initialZoomSettings,0,0),g=b.worldToScreen(this._settings,f.x,f.y),h=b.screenToWorld(this._initialZoomSettings,canvas.width,canvas.height),i=b.worldToScreen(this._settings,h.x,h.y);a=g.x,c=g.y,d=i.x-g.x,e=i.y-g.y}this._ctx.drawImage(this._backCanvas,a,c,d,e),this._ctx.drawImage(this._tempCanvas,a,c,d,e)},_doAction:function(a,b){"stroke"==b.type&&this._drawStroke(a,b.value)},updateSettings:function(a){this._settings=a},_drawStroke:function(a,b){if(!(b.points.length<2)){var c=b.controlPoints,d=b.points,e=d[0],f=b.width;b.lockWidth&&(f/=this._settings.scale),a.lineJoin="round",a.lineWidth=f,a.strokeStyle=b.color,a.lineCap="round",a.beginPath(),a.moveTo(e.x,e.y);for(var g=1;g<d.length;g++)if(e=d[g],this._useCurves||1==g){var h=c[g-1][0],i=c[g-1][1];a.bezierCurveTo(h[0],h[1],i[0],i[1],e[0],e[1])}else a.lineTo(e[0],e[1]);a.stroke()}},zoom:function(a,c,d){var e=this._settings.scale+d;if(1e-6>e||e>20)return!1;this._raster===!1&&(this._initialZoomSettings=b.clone(this._settings));var f=b.screenToWorld(this._settings,a,c);this._settings.scale+=d;var g=b.worldToScreen(this._settings,f.x,f.y),h={x:a-g.x,y:c-g.y};return this._settings.offsetX+=h.x,this._settings.offsetY+=h.y,this._raster=!0,!0},pan:function(a,c){return this._raster===!1&&(this._initialZoomSettings=b.clone(this._settings)),this._settings.offsetX+=a,this._settings.offsetY+=c,!0},panTo:function(a,b){this._settings.offsetX=a,this._settings.offsetY=b}});return c}),d("components/thumbnail",["class","globals","helpers","components/drawCanvas"],function(a,b,c,d){var e=a.extend({_canvas:null,_thumbnailWidth:null,_thumbnailHeight:null,init:function(){var a=document.createElement("canvas");this.setThumbnailSizes(),a.width=this._thumbnailWidth,a.height=this._thumbnailHeight,this._canvas=a},render:function(a,b){var e=new d(this._canvas,a),f=window.devicePixelRatio,g={x:window.innerWidth/2*f,y:window.innerHeight/2*f},h=c.screenToWorld(a,g.x,g.y),i=Math.min(this._canvas.width/window.innerWidth/f,this._canvas.height/window.innerHeight/f),j=a.scale*i-a.scale;e.zoom(0,0,j);var k={x:this._canvas.width/2,y:this._canvas.height/2},l=c.worldToScreen(a,h.x,h.y),m={x:k.x-l.x,y:k.y-l.y};return e.pan(m.x,m.y),e.doAll(b),e.rasterMode(!1),e.render(),this._canvas.toDataURL("image/png")},setThumbnailSizes:function(){var a=15,c=200,d=300;b.isComputer()?(a=15,c=200,d=300):b.isTablet()?(a=15,c=200,d=330):b.isPhone()&&(a=10,c=100,d=160);var e=b.getStylesheet();if(e){var f=b.getStylesheetRules(),g=[];g.push("#files-list { padding-top: "+a+"px !important; }"),g.push("#files-list li {width: "+d+"px;padding: 0px "+a/2+"px "+a+"px "+a/2+"px;}"),g.push("#files-list .create .icon { font-size: "+.5*c+"px; }"),g.push("#files-list .create, #files-list .thumbnail, #files-list .overlay, #files-list .thumbnail-info {height: "+c+"px !important;}"),g.forEach(function(a){e.insertRule(a,f.length)})}this._thumbnailHeight=c*window.devicePixelRatio,this._thumbnailWidth=d*window.devicePixelRatio}});return new e}),d("dataLayer/file",["class","event","helpers","sequentialHelper","bezierCurve","components/thumbnail"],function(a,b,c,d,e,f){var g=a.extend({fileInfoPromise:null,_cachedActions:null,_backing:null,_driveBacking:null,_addedCallback:null,_removedCallback:null,_syncPromise:null,init:function(a){this._backing=a},hasLocalActions:function(a){return this._backing.load(a).then(function(){return this._backing.getActions()}.bind(this)).then(function(a){return this._backing.close().then(function(){return 0!==a.local.length})}.bind(this))},remoteActionsMatch:function(a,b){return Promise.all([this._backing.load(a),b.load(a)]).then(function(){var a=this._backing.getActions(),c=b.getActions();return Promise.all([a,c]).then(function(a){var b=a[0],c=a[1];if(b.remote.length!=c)return!1;for(var d=0;d<b.remote.length;d++)if(b.remote[d].id!=c[d])return!1;return!0})}.bind(this))},load:function(a){var b=this._backing.load(a);return b.then(function(){return this._backing.getActions()}.bind(this)).then(function(a){var c={remoteActions:[],localActions:[],redoStack:[]};return c.remoteActions=a.remote.map(this._convertFromStorage),c.localActions=a.local.map(this._convertFromStorage),this._cachedActions=c,this.fileInfoPromise=b,this}.bind(this))},create:function(a){return this._backing.create(a).then(function(){return this.load(a.id)}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},rename:function(a){return this.fileInfoPromise.then(function(c){var e=Date.now();c.name=a,c.localModifiedTime=e,b.trigger("fileRenamed",c),b.trigger("fileModified",c),this.fileInfoPromise=Promise.resolve(c);var f=[];return f.push(this.fileInfoPromise.then(function(){return this._backing.updateLocalModifiedTime(e)}.bind(this))),f.push(this._backing.rename(a)),this._driveBacking&&f.push(d.startLockedAction(c.id).then(function(){return this._driveBacking.rename(a)}.bind(this)).catch(function(a){console.error(a)}).then(function(){d.endLockedAction(c.id)}.bind(this))),Promise.all(f)}.bind(this))},startDrive:function(a){return console.log("starting"),a.listen(this.remoteActionsAdded.bind(this),this.remoteActionsRemoved.bind(this)),this.fileInfoPromise.then(function(b){return console.log("Starting drive for file",b.id),this.sync(a,!0)}.bind(this)).then(function(){this._driveBacking=a}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},sync:function(a,c){var e=this._driveBacking||a;return this._syncPromise=this.fileInfoPromise.then(function(a){return e._parent.getFileInfo(a.id).catch(function(){return void 0}).then(function(f){console.log("Starting file sync",a.id);var g=[];if(void 0!==f)console.log("Found file",a.id,"on drive"),f.title!=a.name&&g.push(f.driveModifiedTime==a.driveModifiedTime?e.load(a.id).then(function(){return e.rename(a.name)}.bind(this)):this.rename(f.title)),c&&g.push(this._syncRemoteActionsFromDrive(e));else{console.log("File not found on drive",a.id);var h=a.id;g.push(d.startLockedAction(h,!0).then(function(){return e.create(a)}).then(function(c){return this._backing.replaceFileId(c.id).then(function(){return this.load(c.id)}.bind(this)).then(function(){return this._moveSettings(h)}.bind(this)).then(function(){b.trigger("fileIdChanged",{oldId:h,newId:c.id})}).then(function(){return this._backing.getActions()}.bind(this)).then(function(a){var b=a.remote.concat(a.local);return this._sendAllActions(b,e)}.bind(this)).then(function(){return e.rename(a.name)}.bind(this)).catch(function(a){console.error(a)}.bind(this)).then(function(){d.endLockedAction(c.id)})}.bind(this)))}return Promise.all(g)}.bind(this))}.bind(this)).then(function(){this._syncPromise=null}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)}).then(function(){return this.fileInfoPromise}.bind(this)).then(function(a){console.log("Completed file sync",a.id)}),this._syncPromise},listen:function(a,b){this._addedCallback=a,this._removedCallback=b},stopListening:function(){this._addedCallback=null,this._removedCallback=null},getActions:function(){return this._cachedActions.remoteActions.concat(this._cachedActions.localActions)},localSettings:function(a){return this.fileInfoPromise.then(function(b){return a&&(localStorage[b.id]=JSON.stringify(a)),localStorage[b.id]||(localStorage[b.id]=JSON.stringify({offsetX:0,offsetY:0,scale:.005,color:"#000",tools:{point:"pencil",gesture:null,scroll:"pan"}})),JSON.parse(localStorage[b.id])}.bind(this))},_moveSettings:function(a){return localStorage[a]?this.fileInfoPromise.then(function(b){localStorage[b.id]=localStorage[a],delete localStorage[a]}):Promise.resolve()},undo:function(){if(this._driveBacking)return this._driveBacking.undo();if(0===this._cachedActions.localActions.length)return Promise.resolve(!1);var a=this._cachedActions.localActions.pop();return this._cachedActions.redoStack.push(a),this._backing.removeLocalAction(a.id).then(function(){return this.fileInfoPromise}.bind(this)).then(function(a){return a.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(a),b.trigger("fileModified",a),this._backing.updateLocalModifiedTime(a.localModifiedTime)}.bind(this))},redo:function(){if(this._driveBacking)return this._driveBacking.redo();if(0===this._cachedActions.redoStack.length)return Promise.resolve(!1);var a=this._cachedActions.redoStack.pop();return this._addAction(a)},addAction:function(a){return this._cachedActions.redoStack.length=0,this._addAction(a)},_addAction:function(a){this._cachedActions.localActions.push(a);var d=[];d.push(this.fileInfoPromise.then(function(a){return a.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(a),b.trigger("fileModified",a),this._backing.updateLocalModifiedTime(a.localModifiedTime)}.bind(this)));var e=this._prepareForStorage(c.clone(a));return d.push(this._backing.addLocalAction(e)),this._driveBacking&&d.push(this._driveBacking.addAction(e)),Promise.all(d).then(function(){return this.fileInfoPromise}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},"delete":function(){return this.fileInfoPromise.then(function(a){return this.close().then(function(){return delete localStorage[a.id],this._backing._parent.deleteFile(a.id)}.bind(this))}.bind(this))},close:function(){var a=Promise.resolve();return this._syncPromise&&(a=this._syncPromise),this.fileInfoPromise?a.then(function(){this.fileInfoPromise.then(function(){this._cachedActions.length=0,this.fileInfoPromise=Promise.reject(new Error("File has been closed"))}.bind(this));var a=[];return a.push(this._backing.close()),this._driveBacking&&(this._driveBacking.stopListening(),a.push(this._driveBacking.close()),this._driveBacking=null),Promise.all(a)}.bind(this)):a},_syncRemoteActionsFromDrive:function(a){return this.fileInfoPromise.then(function(b){var c=a.load(b.id).then(function(){return a.getActions()}.bind(this)),d=this._backing.getActions();return Promise.all([b,c,d])}.bind(this)).then(function(b){for(var c=b[0],d=b[1],e=b[2],f=[],g=d.length<e.remote.length?d:e.remote,h=-1,i=0;i<g.length;i++)if(d[i].id!=e.remote[i].id){h=i;break}var j,k=!1;if(-1!==h||d.length!=e.remote.length)if(console.log("Differences between remote and local actions",c.id),k=!0,-1!=h){var l=d.slice(h);j=this._indexify(l,h),f.push(this._backing.removeRemoteActions(h,e.remote.length-h).then(function(){this._backing.addRemoteActions(h,j)}.bind(this))),j=j.map(this._convertFromStorage),this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[h,this._cachedActions.remoteActions.length-h].concat(j))}else if(g==d)f.push(this._backing.removeRemoteActions(d.length,e.remote.length-d.length)),this._cachedActions.remoteActions.splice(d.length,e.remote.length-d.length);else{var m=d.slice(e.remote.length);j=this._indexify(m,e.remote.length),f.push(this._backing.addRemoteActions(e.remote.length,j)),j=j.map(this._convertFromStorage),this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[this._cachedActions.remoteActions.length,0].concat(j))}return f.push(this._sendAllActions(e.local,a)),Promise.all(f).then(function(){return k?this.updateThumbnail():void 0}.bind(this))}.bind(this))},_sendAllActions:function(a,b){for(var c=[],d=0;d<a.length;d++){var e=this._prepareForStorage(a[d]);c.push(b.addAction(e))}return Promise.all(c)},remoteActionsAdded:function(a){var d=[];if(a.isLocal)for(var e=0;e<a.values.length;e++){for(var f=0;f<this._cachedActions.localActions.length;f++)if(this._cachedActions.localActions[f].id==a.values[e].id){this._cachedActions.localActions.splice(f,1);
break}d.push(this._backing.removeLocalAction(a.values[e].id))}var g=a.values.map(function(a){var b=c.clone(a);return b.value=c.clone(a.value),this._convertFromStorage(b)}.bind(this));this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[a.index,0].concat(g));var h=this._indexify(a.values,a.index);return d.push(this._backing.addRemoteActions(a.index,h)),this._addedCallback&&this._addedCallback({isLocal:a.isLocal,items:g}),d.push(this.fileInfoPromise.then(function(c){return a.isLocal?b.trigger("fileModified",c):b.trigger("fileModifiedRemotely",c),c.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(c),this._backing.updateLocalModifiedTime(c.localModifiedTime)}.bind(this))),Promise.all(d).catch(function(){}).then(function(){return this.updateThumbnail()}.bind(this))},remoteActionsRemoved:function(a){this._cachedActions.remoteActions.splice(a.index,a.values.length);var c=[];return c.push(this._backing.removeRemoteActions(a.index,a.values.length)),this._removedCallback&&c.push(this._removedCallback()),c.push(this.fileInfoPromise.then(function(a){return a.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(a),b.trigger("fileModified",a),this._backing.updateLocalModifiedTime(a.localModifiedTime)})),Promise.all(c).then(function(){return this.updateThumbnail()}.bind(this))},updateDriveModifiedTime:function(a){return this._backing.updateDriveModifiedTime(a)},updateThumbnail:function(){return this.localSettings().then(function(a){var c=f.render(a,this.getActions());return this.fileInfoPromise.then(function(a){return a.thumbnail=c,b.trigger("thumbnailUpdated",a),this.fileInfoPromise=Promise.resolve(a),this._backing.updateThumbnail(c)}.bind(this))}.bind(this))},_indexify:function(a,b){for(var d=[],e=0;e<a.length;e++){var f=c.clone(a[e]);f.index=e+b,d.push(f)}return d},_prepareForStorage:function(a){var b=c.clone(a);return b.value=c.clone(a.value),delete b.value.controlPoints,b},_convertFromStorage:function(a){var b=e.getCurveControlPoints(a.value.points);return a.value.controlPoints=c.cloneArray(b),a},isConnected:function(){return!!this._driveBacking}});return g}),d("dataLayer/data",["class","helpers","event","gauth","online","sequentialHelper","dataLayer/file"],function(a,b,c,d,e,f,g){var h=a.extend({_backing:null,_cachedFiles:null,_fileReferences:null,_driveBacking:null,init:function(a,b){this._cachedFiles={},this._fileReferences={},this._backing=a,this._driveBacking=b,c.addListener("fileIdChanged",this._fileIdChanged.bind(this))},getFiles:function(){return this._backing.getFiles().catch(function(a){throw console.error(a,a.stack,a.message),a})},createFile:function(){var a={id:b.getGuid(),name:"Untitled File",localModifiedTime:Date.now(),driveModifiedTime:"",thumbnail:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg=="};return this._createFile(a)},_createFile:function(a){var b=new g(new this._backing.instance(this._backing));return this._fileReferences[a.id]=1,this._cachedFiles[a.id]=b.create(a).then(function(a,b){return c.trigger("fileAdded",a),b}.bind(this,a)).catch(function(a){throw console.error(a,a.stack,a.message),a}),d.isAuthenticated()&&this._cachedFiles[a.id].then(function(){b.startDrive(this._newDriveInstance())}.bind(this)),this._cachedFiles[a.id]},loadFile:function(a,b){return this._cachedFiles[a]?(this._fileReferences[a]++,this._cachedFiles[a]):this.fileExists(a).then(function(c){if(!c)throw new Error("This file does not exist");var d=new g(new this._backing.instance(this._backing));return this._fileReferences[a]=1,this._cachedFiles[a]=d.load(a).then(function(){return d}.bind(this)),e.isOnline()&&this._cachedFiles[a].then(function(){var a=d.startDrive(this._newDriveInstance());return b?a:void 0}.bind(this)),this._cachedFiles[a]}.bind(this))},deleteFile:function(a,e){var f=[];if(c.trigger("fileRemoved",a),this._fileReferences[a]&&delete this._fileReferences[a],this._cachedFiles[a]){var g=this._cachedFiles[a];delete this._cachedFiles[a],f.push(g.then(function(a){return this.close(a)}.bind(this)))}return b.isLocalGuid(a)?this._backing.deleteFile(a):!e&&d.isAuthenticated()?this._driveBacking.deleteFile(a).then(function(){return this._backing.deleteFile(a)}.bind(this)):this._backing.markFileAsDeleted(a)},close:function(a){return a.fileInfoPromise.then(function(b){return this._fileReferences[b.id]&&this._fileReferences[b.id]--,this._fileReferences[b.id]>0?Promise.resolve():(delete this._fileReferences[b.id],delete this._cachedFiles[b.id],a.close())}.bind(this))},syncOpenFiles:function(){var a=Promise.resolve();for(var b in this._cachedFiles){var c=this._cachedFiles[b];a=a.then(function(a){return a}.bind(this,c)).then(function(a){var b=new this._driveBacking.instance(this._driveBacking);return a.startDrive(b)}.bind(this))}return a},openReferences:function(a){return this._fileReferences[a]?this._fileReferences[a]:0},_fileIdChanged:function(a){this._cachedFiles[a.oldId]&&(this._fileReferences[a.newId]=this._fileReferences[a.oldId],delete this._fileReferences[a.oldId],this._cachedFiles[a.newId]=this._cachedFiles[a.oldId],delete this._cachedFiles[a.oldId])},_newDriveInstance:function(){return new this._driveBacking.instance(this._driveBacking)},checkForUpdates:function(){function a(a){return a.id}function b(a,b){return a.id<b.id}function c(a,b){return a.id==b.id}function e(a,b,c){for(var d=[],e=0;e<a.length;e++)for(var f=0;f<b.length;f++)if(i(a[e],b[f],c)){d.push({drive:a[e],local:b[f]});break}return d}function h(a,b,c){for(var d=[],e=0;e<a.length;e++){for(var f=!1,g=0;g<b.length;g++)if(c(a[e],b[g])){f=!0;break}f||d.push(a[e])}return d}function i(a,b,c){return c(a,b)}return d.isAuthenticated()?f.hasActions()?(console.warn("Actions currently running, can't sync"),Promise.reject()):f.startGlobalAction().then(function(){console.log("Checking for file updates on drive");var d=this._driveBacking.getFiles(),f=this._backing.getFiles(),i=this._backing.getDeletedFiles();return Promise.all([d,f,i]).then(function(d){var f=d[0].sort(b),i=d[1].sort(b),j=d[2].sort(b),k=(i.map(a),f.map(a)),l=j.map(a),m=l.filter(function(a){return-1===k.indexOf(a)}),n=h(f,i,c),o=h(i,f,c),p=e(f,i,c),q=[],r=Promise.resolve();return m.map(function(a){q.push(this._backing.deleteFile(a))}.bind(this)),r=n.reduce(function(a,b){return a.then(function(a){var b=-1!==l.indexOf(a.id);return this._fileNotFoundLocally(a,b)}.bind(this,b))}.bind(this),r),r=o.reduce(function(a,b){return a.then(function(a){var b=-1!==l.indexOf(a.id);return this._fileNotFoundOnRemote(a,b)}.bind(this,b))}.bind(this),r),r=p.reduce(function(a,b){return a.then(function(a){var b=a.drive,c=a.local,d=new g(new this._backing.instance(this._backing)),e=d.hasLocalActions(c.id);return e.then(function(a){return b.modifiedDate!=c.driveModifiedTime||a||b.title!=c.name?this.loadFile(c.id,!0).then(function(a){return a.updateDriveModifiedTime(b.modifiedDate).then(function(){return this.close(a)}.bind(this))}.bind(this)):void console.log("No local changes, skipping",c.id)}.bind(this))}.bind(this,b))}.bind(this),r),q.push(r),Promise.all(q)}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)}).then(function(){console.log("Completed checking for Drive updates")}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})}.bind(this)).then(function(){f.endGlobalAction()}):Promise.resolve()},_fileNotFoundLocally:function(a,b){if(b){console.log(a.id,"was deleted");var c=new g(new this._backing.instance(this._backing));return c.remoteActionsMatch(a.id,this._newDriveInstance()).then(function(b){if(b)return console.log("Deleting",a.id,"on remote"),this.deleteFile(a.id);console.log("Readding",a.id,"on remote");var c=this.loadFile(a.id).then(function(a){return this.close(a)}.bind(this));return Promise.all([this._backing.unmarkFileAsDeleted(a.id),c])}.bind(this))}return this._createFileFromRemote(a)},_fileNotFoundOnRemote:function(a,c){if(c)return this.deleteFile(a.id,!0);var d=!b.isLocalGuid(a.id);return d?this.deleteFile(a.id,!0):this.loadFile(a.id,!0).then(function(a){return this.close(a)}.bind(this))},getRemoteFileInfo:function(a){return this.isReadableRemoteFile(a).then(function(b){if(b)return this._driveBacking.getFileInfo(a);throw"File does not exist or is not readable"}.bind(this))},loadFileFromRemote:function(a){return this.getRemoteFileInfo(a).then(function(b){return Promise.all([this._driveBacking.touchFile(a),this._createFileFromRemote(b)]).then(function(a){return a[1]})}.bind(this))},_createFileFromRemote:function(a){var b={id:a.id,name:a.title,localModifiedTime:Date.now(),driveModifiedTime:a.modifiedDate,thumbnail:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg=="};return this._createFile(b).then(function(a){return this.close(a)}.bind(this)).then(function(){return b}.bind(this))},isReadableRemoteFile:function(a){return e.isOnline()?this._driveBacking.canReadFile(a):Promise.reject(new Error("Not connected to drive"))},shareFilePublicly:function(a){return e.isOnline()?this._driveBacking.shareFilePublicly(a):Promise.reject(new Error("Not connected to drive"))},disablePublicFile:function(a){return e.isOnline()?this._driveBacking.disablePublicFile(a):Promise.reject(new Error("Not connected to drive"))},getFilePermissions:function(a){return e.isOnline()?this._driveBacking.getFilePermissions(a):Promise.reject(new Error("Not connected to drive"))},clearLocal:function(){return this._backing.clearAll().then(function(){this._backing.init()}.bind(this))},fileExists:function(a){return this._backing.fileExists(a)}});return h}),d("db",[],function(){var a=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,b=window.IDBKeyRange||window.webkitIDBKeyRange,c={readonly:"readonly",readwrite:"readwrite"},d=Object.prototype.hasOwnProperty;if(a){var e=function(a){return a},f=function(){var a,b=[],c=function(c,d){if(b){d=d||[],a=a||[c,d];for(var e=0,f=b.length;f>e;e++)b[e].apply(a[0],a[1]);b=[]}};this.add=function(){for(var d=0,e=arguments.length;e>d;d++)b.push(arguments[d]);return a&&c(),this},this.execute=function(){return c(this,arguments),this}},g=function(a){var b="progress",c=[["resolve","done",new f,"resolved"],["reject","fail",new f,"rejected"],["notify","progress",new f]],d={},e={state:function(){return b},then:function(){var a=arguments;return g(function(b){c.forEach(function(c,e){var f=a[e];d[c[1]]("function"==typeof f?function(){var a=f.apply(this,arguments);a&&"function"==typeof a.promise&&a.promise().done(b.resolve).fail(b.reject).progress(b.notify)}:b[c[0]])})}).promise()},promise:function(a){return a?(Object.keys(e).forEach(function(b){a[b]=e[b]}),a):e}};return c.forEach(function(a){var c=a[2],f=a[3];e[a[1]]=c.add,f&&c.add(function(){b=f}),d[a[0]]=c.execute}),e.promise(d),a&&a.call(d,d),d},h=function(a){var b=this,e=!1;this.add=function(d){if(e)throw new Error("Database has been closed");for(var f=[],h=0;h<arguments.length-1;h++)f[h]=arguments[h+1];var i=a.transaction(d,c.readwrite),j=i.objectStore(d),k=g();return f.forEach(function(a){var b;if(a.item&&a.key){var c=a.key;a=a.item,b=j.add(a,c)}else b=j.add(a);b.onsuccess=function(b){var c=b.target,d=c.source.keyPath;null===d&&(d="__id__"),Object.defineProperty(a,d,{value:c.result,enumerable:!0}),k.notify()}}),i.oncomplete=function(){k.resolve(f,b)},i.onerror=function(a){var b=new Error;b.dbError=a,a.records=f,k.reject(b)},i.onabort=function(a){var b=new Error;b.dbError=a,a.records=f,k.reject(b)},k.promise()},this.update=function(d){if(e)throw new Error("Database has been closed");for(var f=[],h=0;h<arguments.length-1;h++)f[h]=arguments[h+1];var i=a.transaction(d,c.readwrite),j=i.objectStore(d),k=(j.keyPath,g());return f.forEach(function(a){var b;if(a.item&&a.key){var c=a.key;a=a.item,b=j.put(a,c)}else b=j.put(a);b.onsuccess=function(){k.notify()}}),i.oncomplete=function(){k.resolve(f,b)},i.onerror=function(a){var b=new Error;b.dbError=a,a.records=f,k.reject(b)},i.onabort=function(a){var b=new Error;b.dbError=a,a.records=f,k.reject(b)},k.promise()},this.remove=function(b,d){if(e)throw new Error("Database has been closed");{var f=a.transaction(b,c.readwrite),h=f.objectStore(b),i=g();h.delete(d)}return f.oncomplete=function(){i.resolve(d)},f.onerror=function(a){var b=new Error;b.dbError=a,i.reject(b)},i.promise()},this.clear=function(b){if(e)throw new Error("Database has been closed");{var d=a.transaction(b,c.readwrite),f=d.objectStore(b),h=g();f.clear()}return d.oncomplete=function(){h.resolve()},d.onerror=function(a){var b=new Error;b.dbError=a,h.reject(b)},h.promise()},this.close=function(){if(e)throw new Error("Database has been closed");a.close(),e=!0},this.get=function(b,c){if(e)throw new Error("Database has been closed");var d=a.transaction(b),f=d.objectStore(b),h=g(),i=f.get(c);return i.onsuccess=function(a){h.resolve(a.target.result)},d.onerror=function(a){var b=new Error;b.dbError=a,h.reject(b)},h.promise()},this.query=function(b,c){if(e)throw new Error("Database has been closed");return new i(b,a,c)};for(var f=0,h=a.objectStoreNames.length;h>f;f++)!function(a){b[a]={};for(var c in b)d.call(b,c)&&"close"!==c&&(b[a][c]=function(c){return function(){var d=[a].concat([].slice.call(arguments,0));return b[c].apply(b,d)}}(c))}(a.objectStoreNames[f])},i=function(a,d,f){var h=this,i=!1,j=!1,k=function(e,h,k,l,m,n,o){var p=d.transaction(a,i||j?c.readwrite:c.readonly),q=p.objectStore(a),r=f?q.index(f):q,s=e?b[e].apply(null,h):null,t=[],u=g(),v=[s],m=m?m:null,n=n?n:[],w=0;"count"!==k&&v.push(l||"next");var x=i?Object.keys(i):!1,y=function(a){for(var b=0;b<x.length;b++){var c=x[b],d=i[c];d instanceof Function&&(d=d(a)),a[c]=d}return a},z=j instanceof Function?j:!1;return r[k].apply(r,v).onsuccess=function(a){var b=a.target.result;if("number"==typeof b)t=b;else if(b)if(null!==m&&m[0]>w)w=m[0],b.advance(m[0]);else if(null!==m&&w>=m[0]+m[1]);else{var c=!0,d="value"in b?b.value:b.key;n.forEach(function(a){a&&a.length&&(c=2===a.length?d[a[0]]===a[1]:a[0].apply(void 0,[d]))}),c&&(w++,t.push(o(d)),i&&(d=y(d),b.update(d)),j&&z(d)&&b.delete(d)),b.continue()}},p.oncomplete=function(){u.resolve(t)},p.onerror=function(a){var b=new Error;b.dbError=a,u.reject(b)},p.onabort=function(a){var b=new Error;b.dbError=a,u.reject(b)},u.promise()},l=function(a,b){var c="next",d="openCursor",f=[],g=null,h=e,l=!1,m=function(){return k(a,b,d,l?c+"unique":c,g,f,h)},n=function(){return g=Array.prototype.slice.call(arguments,0,2),1==g.length&&g.unshift(0),{execute:m,modify:t,remove:u}},o=function(){return c=null,d="count",{execute:m}},p=function(){return d="openKeyCursor",{desc:r,execute:m,filter:q,distinct:s,map:v}},q=function(){return f.push(Array.prototype.slice.call(arguments,0,2)),{keys:p,execute:m,filter:q,desc:r,distinct:s,modify:t,remove:u,limit:n,map:v}},r=function(){return c="prev",{keys:p,execute:m,filter:q,distinct:s,modify:t,remove:u,map:v}},s=function(){return l=!0,{keys:p,count:o,execute:m,filter:q,desc:r,modify:t,remove:u,map:v}},t=function(a){return i=a,{execute:m}},u=function(a){return j="undefined"==typeof a?function(){return!0}:a,{execute:m}},v=function(a){return h=a,{execute:m,count:o,keys:p,filter:q,desc:r,distinct:s,modify:t,remove:u,limit:n,map:v}};return{execute:m,count:o,keys:p,filter:q,desc:r,distinct:s,modify:t,remove:u,limit:n,map:v}};"only bound upperBound lowerBound".split(" ").forEach(function(a){h[a]=function(){return new l(a,arguments)}}),this.filter=function(){var a=new l(null,null);return a.filter.apply(a,arguments)},this.all=function(){return this.filter()}},j=function(a,b,c){"function"==typeof b&&(b=b());for(var e in b){var f,g=b[e];f=!d.call(b,e)||c.objectStoreNames.contains(e)?a.currentTarget.transaction.objectStore(e):c.createObjectStore(e,g.key);for(var h in g.indexes)if(!f.indexNames.contains(h)){var i=g.indexes[h];f.createIndex(h,i.key||h,Object.keys(i).length?i:{unique:!1})}}},k=function(a,b){var c=a.target.result,d=new h(c,b),e=g();return e.resolve(d),e.promise()},l={version:"0.9.0",open:function(b){var c,d=g();return c=a.open(b.server,b.version),c.onsuccess=function(a){k(a,b.server,b.version,b.schema).done(d.resolve).fail(d.reject).progress(d.notify)},c.onupgradeneeded=function(a){j(a,b.schema,a.target.result)},c.onerror=function(a){var b=new Error;b.dbError=a,d.reject(b)},d.promise()}};return l}}),d("dataLayer/indexedDBBacking",["class","helpers","db","event"],function(a,b,c,d){var e=a.extend({_parent:null,_fileInfoPromise:null,_fileServerPromise:null,init:function(a){this._parent=a},load:function(a){return this._fileServerPromise=Promise.cast(c.open({server:a,version:2,schema:{localActions:{key:{keyPath:"id"}},remoteActions:{key:{keyPath:"id"},indexes:{id:{unique:!0},index:{unique:!0}}}}})),this._fileInfoPromise=this._parent.getFileInfo(a),Promise.all([this._fileServerPromise,this._fileInfoPromise]).then(function(a){return a[1]})},create:function(a){return this._parent._addFile(a).then(function(){return this.load(a.id)}.bind(this))},getActions:function(){return this._fileServerPromise.then(function(a){var b=Promise.cast(a.localActions.query().all().execute()),c=Promise.cast(a.remoteActions.query("index").all().execute());return Promise.all([b,c]).then(function(a){return{local:a[0],remote:a[1]}})}.bind(this))},rename:function(a){return this._fileInfoPromise.then(function(b){return this._parent._renameFile(b.id,a).then(function(a){this._fileInfoPromise=Promise.cast(a)})}.bind(this))},updateThumbnail:function(a){return this._fileInfoPromise.then(function(b){return this._parent._updateThumbnail(b.id,a)}.bind(this))},addLocalAction:function(a){return this._fileServerPromise.then(function(b){return Promise.cast(b.localActions.add(a))}.bind(this))},removeLocalAction:function(a){return this._fileServerPromise.then(function(b){return Promise.cast(b.localActions.remove(a))}.bind(this))},addRemoteActions:function(a,b){return this._fileServerPromise.then(function(c){return Promise.cast(c.remoteActions.query("index").lowerBound(a).desc().modify({index:function(a){return a.index+b.length}}).execute()).then(function(){return Promise.cast(c.remoteActions.add.apply(c.remoteActions,b))})}.bind(this))},removeRemoteActions:function(a,b){return this._fileServerPromise.then(function(c){return Promise.cast(c.remoteActions.query("index").lowerBound(a).limit(b).remove().execute()).then(function(){return Promise.cast(c.remoteActions.query("index").lowerBound(a).modify({index:function(a){return a.index-b}}).execute())})}.bind(this))},replaceFileId:function(a){return this._fileInfoPromise.then(function(b){var c=this.getActions(),d=b.id;b.id=a;return this._fileInfoPromise=Promise.cast(b),Promise.all([c,this._fileInfoPromise]).then(function(a){var b=a[0],c=a[1];return this._parent._addFile(c).then(function(a){return this.load(a[0].id)}.bind(this)).then(function(){return this._copyAllActions(b)}.bind(this)).then(function(){return this._parent.deleteFile(d)}.bind(this)).then(function(){return c})}.bind(this))}.bind(this))},close:function(){return this._fileServerPromise.then(function(a){return this._fileServerPromise=Promise.reject(new Error("File Server has been closed")),this._fileInfoPromise=Promise.reject(new Error("File has been closed")),a.close()}.bind(this))},updateLocalModifiedTime:function(a){return this._fileInfoPromise.then(function(b){return b.localModifiedTime=a,this._fileInfoPromise=Promise.resolve(b),this._parent._updateLocalModifiedTime(b.id,a)}.bind(this))},updateDriveModifiedTime:function(a){return this._fileInfoPromise.then(function(b){return b.driveModifiedTime=a,this._fileInfoPromise=Promise.resolve(b),this._parent._updateDriveModifiedTime(b.id,a)}.bind(this))},_copyAllActions:function(a){return this._fileServerPromise.then(function(b){return Promise.all([Promise.cast(b.localActions.add.apply(b,a.local)),Promise.cast(b.remoteActions.add.apply(b,a.remote))]).catch(function(a){console.error("Failed copying actions",a,a.stack,a.message)})})}}),f=a.extend({readyPromise:null,_serverName:null,init:function(a){this._serverName=a?a:"draw",this.readyPromise=Promise.cast(c.open({server:this._serverName,version:2,schema:{files:{key:{keyPath:"id"},indexes:{id:{unique:!0},localModifiedTime:{}}}}}))},fileExists:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.query("id").only(a).count().execute()).then(function(a){return 0!==a}.bind(this))}.bind(this))},getFiles:function(){return this.readyPromise.then(function(a){return Promise.cast(a.files.query("localModifiedTime").all().filter(function(a){return!a.deleted}).desc().execute()).then(function(a){return a.map(this._cleanFields)}.bind(this))}.bind(this))},_addFile:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.add(a))})},_renameFile:function(a,b){return this.readyPromise.then(function(c){return Promise.cast(c.files.query("id").only(a).modify({name:b}).execute()).then(function(a){return a}.bind(this))}.bind(this))},_updateThumbnail:function(a,b){return this.readyPromise.then(function(c){return Promise.cast(c.files.query("id").only(a).modify({thumbnail:b}).execute()).then(function(a){return a}.bind(this))}.bind(this))},getDeletedFiles:function(){return this.readyPromise.then(function(a){return Promise.cast(a.files.query().filter(function(a){return a.deleted}).execute()).then(function(a){return a.map(this._cleanFields)}.bind(this))}.bind(this))},markFileAsDeleted:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.query("id").only(a).modify({deleted:!0}).execute())})},unmarkFileAsDeleted:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.query("id").only(a).modify({deleted:!1}).execute()).then(function(a){return d.trigger("fileAdded",a[0]),a})})},deleteFile:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.query("id").only(a).remove().execute()).then(function(b){return indexedDB.deleteDatabase(a),b})})},getFileInfo:function(a){return this.readyPromise.then(function(b){return Promise.cast(b.files.query("id").only(a).execute()).then(function(a){return 0==a.length?void 0:a[0]})}).then(function(a){return a&&this._cleanFields(a),a}.bind(this))},_updateLocalModifiedTime:function(a,b){return this.readyPromise.then(function(c){return Promise.cast(c.files.query("id").only(a).modify({localModifiedTime:b}).execute())})},_updateDriveModifiedTime:function(a,b){return this.readyPromise.then(function(c){return Promise.cast(c.files.query("id").only(a).modify({driveModifiedTime:b}).execute())})},clearAll:function(){return Promise.all([this.getFiles(),this.getDeletedFiles()]).then(function(a){return a[0].concat(a[1])}.bind(this)).then(function(a){return a.map(function(a){return this.deleteFile(a.id)}.bind(this)),Promise.all(a).then(function(){indexedDB.deleteDatabase(this._serverName)}.bind(this))}.bind(this))},_cleanFields:function(a){return a.deleted&&delete a.deleted,a},instance:e});return f}),d("dataLayer/webSQLBacking",["class","helpers","event"],function(a,b){var c=a.extend({_parent:null,_fileId:null,init:function(a){this._parent=a},load:function(a){return this._fileId=a,this._parent.getFileInfo(a)},create:function(a){return this._parent._addFile(a).then(function(){return this.load(a.id)}.bind(this))},getActions:function(){return this._parent.readyPromise.then(function(a){return new Promise(function(b,c){a.readTransaction(function(a){var d=[];d.push(new Promise(function(b,c){a.executeSql("SELECT * FROM `F"+this._fileId+"-local`",[],function(a,c){var d=this._parent._convertResultToObject(c,["value"]);b(d)}.bind(this),function(a,b){c(b)})}.bind(this))),d.push(new Promise(function(b,c){a.executeSql("SELECT * FROM `F"+this._fileId+"-remote` ORDER BY `index`",[],function(a,c){var d=this._parent._convertResultToObject(c,["value"]);b(d)}.bind(this),function(a,b){c(b)})}.bind(this))),Promise.all(d).then(function(a){b({local:a[0],remote:a[1]})}).catch(function(a){c(a)})}.bind(this))}.bind(this))}.bind(this))},rename:function(a){return this._parent._renameFile(this._fileId,a)},updateThumbnail:function(a){return this._parent._updateThumbnail(this._fileId,a)},addLocalAction:function(a){return this._parent.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){b.executeSql("INSERT INTO `F"+this._fileId+"-local` (id, type, value) VALUES (?, ?, ?)",[a.id,a.type,JSON.stringify(a.value)],function(a,b){var d=this._parent._convertResultToObject(b,["value"]);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},removeLocalAction:function(a){return this._parent.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){b.executeSql("DELETE FROM `F"+this._fileId+"-local` WHERE id = ?",[a],function(a,b){var d=this._parent._convertResultToObject(b,["value"]);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},addRemoteActions:function(a,b){return this._parent.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("UPDATE `F"+this._fileId+"-remote` SET `index` = `index` + ? WHERE `index` >= ?",[b.length,a],function(){var a=[];b.forEach(function(b){a.push(new Promise(function(a,d){c.executeSql("INSERT INTO `F"+this._fileId+"-remote` (id, `index`, type, value) VALUES (?, ?, ?, ?)",[b.id,b.index,b.type,JSON.stringify(b.value)],function(b,c){a(c)},function(a,b){d(b)})}.bind(this)))}.bind(this)),Promise.all(a).then(function(a){d(a)}).catch(function(a){e(a)})}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},removeRemoteActions:function(a,b){return this._parent.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("DELETE FROM `F"+this._fileId+"-remote` WHERE `index` between ? and ?",[a,a+b-1],function(){c.executeSql("UPDATE `F"+this._fileId+"-remote` SET `index` = `index` - ? WHERE `index` >= ?",[b,a],function(a,b){d(b)},function(a,b){e(b)})}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},replaceFileId:function(a){return this._parent._replaceFileId(this._fileId,a).then(function(){this._fileId=a}.bind(this)).catch(function(a){throw console.error("Error replacing fileId",a),a})},close:function(){return this._fileId=null,Promise.resolve()},updateLocalModifiedTime:function(a){return this._parent._updateLocalModifiedTime(this._fileId,a)},updateDriveModifiedTime:function(a){return this._parent._updateDriveModifiedTime(this._fileId,a)}}),d=a.extend({FIELDS:"id, name, localModifiedTime, driveModifiedTime, thumbnail",readyPromise:null,_serverName:null,init:function(a){this._serverName=a?a:"files";var b=openDatabase("draw","","draw",4194304);this.readyPromise=Promise.resolve(b).then(function(a){return new Promise(function(b,c){a.transaction(function(d){d.executeSql("CREATE TABLE IF NOT EXISTS `"+this._serverName+"`(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),localModifiedTime INTEGER,driveModifiedTime VARCHAR(255),thumbnail TEXT,deleted BOOL)",[],function(){b(a)},function(a,b){c(b)})}.bind(this))}.bind(this)).then(function(){var b=Promise.resolve();return"1.0"==a.version&&(b=b.then(function(){return new Promise(function(b,c){a.changeVersion(a.version,"2",function(a){a.executeSql("DROP TABLE IF EXISTS `files`",[],function(){b()},function(a,b){c(b)})}.bind(this),function(a){c(a)})}.bind(this)).then(function(){location.reload()})}.bind(this))),b}.bind(this))}.bind(this)).then(function(){return b}).catch(function(a){throw console.error("Error initializing database",a),a})},fileExists:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){b.executeSql("SELECT COUNT(*) AS count FROM `"+this._serverName+"` WHERE id = ?",[a],function(a,b){c(0!==b.rows.item(0).count)}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},getFiles:function(){return this.readyPromise.then(function(a){return new Promise(function(b,c){a.readTransaction(function(a){a.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE `deleted`='false' ORDER BY localModifiedTime DESC",[],function(a,c){var d=this._convertResultToObject(c);b(d)}.bind(this),function(a,b){c(b)})}.bind(this))}.bind(this))}.bind(this))},_addFile:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){var e=[];e.push(new Promise(function(c,d){b.executeSql("INSERT INTO `"+this._serverName+"` VALUES (?, ?, ?, ?, ?, ?)",[a.id,a.name,a.localModifiedTime,a.driveModifiedTime,a.thumbnail,!1],function(a,b){c(b)},function(a,b){d(b)})}.bind(this))),e.push(new Promise(function(c,d){b.executeSql("CREATE TABLE IF NOT EXISTS `F"+a.id+"-local` (id VARCHAR(255) PRIMARY KEY, type VARCHAR(255), value TEXT)",[],function(a,b){c(b)},function(a,b){d(b)})}.bind(this))),e.push(new Promise(function(c,d){b.executeSql("CREATE TABLE IF NOT EXISTS `F"+a.id+"-remote` (id VARCHAR(255) PRIMARY KEY, `index` INTEGER, type VARCHAR(255), value TEXT)",[],function(a,b){c(b)},function(a,b){d(b)})}.bind(this))),Promise.all(e).then(function(){c()}).catch(function(a){d(a)})}.bind(this))}.bind(this))}.bind(this))},_renameFile:function(a,b){return this.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("UPDATE `"+this._serverName+"` SET name = ? WHERE id = ?",[b,a],function(a,b){var c=this._convertResultToObject(b);d(c[0])}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},_updateThumbnail:function(a,b){return this.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("UPDATE `"+this._serverName+"` SET thumbnail = ? WHERE id = ?",[b,a],function(a,b){var c=this._convertResultToObject(b);d(c[0])}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},_replaceFileId:function(a,b){return this.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){var f=[];f.push(new Promise(function(d,e){c.executeSql("UPDATE `"+this._serverName+"` SET id = ? WHERE id = ?",[b,a],function(a,b){var c=this._convertResultToObject(b);d(c[0])}.bind(this),function(a,b){e(b)})}.bind(this))),f.push(new Promise(function(d,e){c.executeSql("ALTER TABLE `F"+a+"-local` RENAME TO `F"+b+"-local`",[],function(a,b){d(b)},function(a,b){e(b)})})),f.push(new Promise(function(d,e){c.executeSql("ALTER TABLE `F"+a+"-remote` RENAME TO `F"+b+"-remote`",[],function(a,b){d(b)},function(a,b){e(b)})})),Promise.all(f).then(function(a){d(a[0])}).catch(function(a){e(a)})}.bind(this))}.bind(this))}.bind(this))},getDeletedFiles:function(){return this.readyPromise.then(function(a){return new Promise(function(b,c){a.readTransaction(function(a){a.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE `deleted`='true' ORDER BY localModifiedTime DESC",[],function(a,c){var d=this._convertResultToObject(c);b(d)}.bind(this),function(a,b){c(b)})}.bind(this))}.bind(this))}.bind(this))},markFileAsDeleted:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){b.executeSql("UPDATE `"+this._serverName+"` SET deleted = ? WHERE id = ?",[!0,a],function(a,b){var d=this._convertResultToObject(b);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},unmarkFileAsDeleted:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){b.executeSql("UPDATE `"+this._serverName+"` SET deleted = ? WHERE id = ?",[!1,a],function(a,b){var d=this._convertResultToObject(b);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},deleteFile:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.transaction(function(b){var e=[];e.push(new Promise(function(c,d){b.executeSql("DELETE FROM `"+this._serverName+"` WHERE id = ?",[a],function(a,b){var d=this._convertResultToObject(b);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))),e.push(new Promise(function(c,d){b.executeSql("DROP TABLE IF EXISTS `F"+a+"-local`",[],function(){c()
}.bind(this),function(a,b){d(b)})})),e.push(new Promise(function(c,d){b.executeSql("DROP TABLE IF EXISTS `F"+a+"-remote`",[],function(){c()}.bind(this),function(a,b){d(b)})})),Promise.all(e).then(function(a){c(a[0])}).catch(function(a){d(a)})}.bind(this))}.bind(this))}.bind(this))},getFileInfo:function(a){return this.readyPromise.then(function(b){return new Promise(function(c,d){b.readTransaction(function(b){b.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE id = ?",[a],function(a,b){var d=this._convertResultToObject(b);c(d[0])}.bind(this),function(a,b){d(b)})}.bind(this))}.bind(this))}.bind(this))},_updateLocalModifiedTime:function(a,b){return this.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("UPDATE `"+this._serverName+"` SET localModifiedTime = ? WHERE id = ?",[b,a],function(a,b){var c=this._convertResultToObject(b);d(c[0])}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},_updateDriveModifiedTime:function(a,b){return this.readyPromise.then(function(c){return new Promise(function(d,e){c.transaction(function(c){c.executeSql("UPDATE `"+this._serverName+"` SET driveModifiedTime = ? WHERE id = ?",[b,a],function(a,b){var c=this._convertResultToObject(b);d(c[0])}.bind(this),function(a,b){e(b)})}.bind(this))}.bind(this))}.bind(this))},_convertResultToObject:function(a,c){for(var d=a.rows,e=new Array(d.length),f=0;f<d.length;f++){var g=d.item(f);if(e[f]=b.clone(g),c)for(var h=0;h<c.length;h++){var i=e[f][c[h]];if(i){var j=JSON.parse(i);e[f][c[h]]=j}}}return e},clearAll:function(){return Promise.all([this.getFiles(),this.getDeletedFiles()]).then(function(a){return a[0].concat(a[1])}.bind(this)).then(function(a){return a.map(function(a){return this.deleteFile(a.id)}.bind(this)),Promise.all(a).then(function(){return this.readyPromise}.bind(this)).then(function(a){return new Promise(function(b,c){a.transaction(function(a){a.executeSql("DROP TABLE `"+this._serverName+"`",[],function(){b()}.bind(this),function(a,b){c(b)})}.bind(this))}.bind(this))}.bind(this))}.bind(this))},instance:c});return d}),d("dataLayer/driveBacking",["class","helpers","gauth"],function(a,b,c){var d=a.extend({_parent:null,_docPromise:null,_addedCallback:null,_removedCallback:null,_updateFileTimeout:null,init:function(a){this._parent=a,this._actionsAdded=this._actionsAdded.bind(this),this._actionsRemoved=this._actionsRemoved.bind(this),this._saveStateChanged=this._saveStateChanged.bind(this)},listen:function(a,b){this._addedCallback=a,this._removedCallback=b},stopListening:function(){this._addedCallback=null,this._removedCallback=null},load:function(a){return this._parent._open(a).then(function(a){return this._openForRealtime(a.id)}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},create:function(a){return this._parent._add(a).then(function(a){return this._openForRealtime(a.id).then(function(){return a})}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},_openForRealtime:function(a){return new Promise(function(b,d){gapi.drive.realtime.load(a,function(a){this._docPromise=Promise.resolve(a),this._docPromise.then(function(a){var c=a.getModel().getRoot().get("actions");c.addEventListener(gapi.drive.realtime.EventType.VALUES_ADDED,this._actionsAdded),c.addEventListener(gapi.drive.realtime.EventType.VALUES_REMOVED,this._actionsRemoved),a.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,this._saveStateChanged),b(this._docPromise)}.bind(this))}.bind(this),function(b){var c=b.createList(),d=b.getRoot();d.set("title","Untitled File"),d.set("actions",c),d.set("id",a)},function(a){if(a.type==gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED)return console.warn("Token expired, reauthorizing"),void c.authorize();a.type==gapi.drive.realtime.ErrorType.CLIENT_ERROR||a.type==gapi.drive.realtime.ErrorType.NOT_FOUND;var a=new Error;a.object=a,d(a)})}.bind(this))},_actionsAdded:function(a){this._addedCallback&&this._addedCallback(a)},_actionsRemoved:function(a){this._removedCallback&&this._removedCallback(a)},_saveStateChanged:function(){this._updateFileTimeout&&clearTimeout(this._updateFileTimeout),this._updateFileTimeout=setTimeout(function(){this._docPromise.then(function(a){this._parent.touchFile(a.getModel().getRoot().get("id")).then(function(a){console.log("Touched file",a)}).catch(function(a){console.error("Error touching file",a)})}.bind(this))}.bind(this),2e3)},getActions:function(){return this._docPromise.then(function(a){return a.getModel().getRoot().get("actions").asArray()})},rename:function(a){return this._docPromise.then(function(b){return b.getModel().getRoot().set("title",a),this._parent._renameFile(b.getModel().getRoot().get("id"),a)}.bind(this))},addAction:function(a){return this._docPromise.then(function(b){var c=b.getModel().getRoot().get("actions");c.insert(c.length,a)})},removeAction:function(a){return this._docPromise.then(function(b){var c=b.getModel().getRoot().get("actions");c.remove(a)})},undo:function(){return this._docPromise.then(function(a){a.getModel().undo()})},redo:function(){return this._docPromise.then(function(a){a.getModel().redo()})},close:function(){return!this._docPromise,this._docPromise.then(function(a){a.close()})}}),e=a.extend({_appId:450627732299,_key:"AIzaSyAOU0dwrVt0XNvGibqE93ATS2X1bMP5pAI",REALTIME_MIMETYPE:"application/vnd.google-apps.drive-sdk",APP_MIMETYPE:null,_fields:"id,modifiedDate,shared,title,userPermission(role)",init:function(){this.APP_MIMETYPE=this.REALTIME_MIMETYPE+"."+this._appId},getFiles:function(){return new Promise(function(a,b){gapi.client.load("drive","v2",function(){gapi.client.drive.files.list({q:"trashed=false and mimeType='"+this.APP_MIMETYPE+"'",fields:"items("+this._fields+")"}).execute(function(c){if(!c)return void a([]);if(c.error){var d=new Error;d.object=c,b(d)}else a(c.items)})}.bind(this))}.bind(this))},getFileInfo:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:a,fields:this._fields+",owners(displayName,picture)",key:this._key}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a)}.bind(this))}.bind(this))}.bind(this))},canReadFile:function(a){return new Promise(function(b){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:a,fields:"mimeType",key:this._key}).execute(function(a){b(a.error?!1:a.mimeType==this.APP_MIMETYPE?!0:!1)}.bind(this))}.bind(this))}.bind(this))},_open:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:a,fields:this._fields}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b({id:a.id})}.bind(this))}.bind(this))}.bind(this))},_add:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.files.insert({resource:{mimeType:this.REALTIME_MIMETYPE,title:a.name},fields:this._fields}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b({id:a.id})})}.bind(this))}.bind(this))},_renameFile:function(a,b){return new Promise(function(c,d){var e={title:b};gapi.client.load("drive","v2",function(){var b=gapi.client.drive.files.patch({fileId:a,resource:e,fields:this._fields});b.execute(function(a){if(a.error){var b=new Error;b.object=a,d(b)}else c(a)})}.bind(this))}.bind(this))},deleteFile:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.files.trash({fileId:a,fields:this._fields}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a)})}.bind(this))}.bind(this))},touchFile:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.files.touch({fileId:a,fields:this._fields}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a)})}.bind(this))}.bind(this))},shareFilePublicly:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){var d={value:"",type:"anyone",role:"writer",withLink:!1};gapi.client.drive.permissions.insert({fileId:a,resource:d}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a)})}.bind(this))}.bind(this))},disablePublicFile:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.permissions.delete({fileId:a,permissionId:"anyone"}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a)})}.bind(this))}.bind(this))},getFilePermissions:function(a){return new Promise(function(b,c){gapi.client.load("drive","v2",function(){gapi.client.drive.permissions.list({fileId:a}).execute(function(a){if(a.error){var d=new Error;d.object=a,c(d)}else b(a.items)})}.bind(this))}.bind(this))},instance:d});return e}),d("data",["dataLayer/data","event","dataLayer/indexedDBBacking","dataLayer/webSQLBacking","dataLayer/driveBacking"],function(a,b,c,d,e){var f;f=window.indexedDB?new c:new d;var g=new e,h=new a(f,g);return b.addListener("authenticatedStatusChanged",function(a){a.authenticated&&(console.log("Syncing open files"),h.syncOpenFiles())}),h}),d("migrate",["data"],function(){var a=function(){this.init()};return a.prototype={init:function(){},run:function(){var a=localStorage.dataVersion,b=Promise.resolve();return a||(b=b.then(function(){}.bind(this)).then(function(){})),b}},new a}),d("section",["class"],function(a){var b=a.extend({id:null,element:null,_visible:null,init:function(){this.id&&(this.element=document.getElementById(this.id)),this._visible=!1},setElement:function(a){this.element=a},show:null,hide:null,afterShow:function(){this.element&&(this.element.style.display="block"),this._visible=!0},afterHide:function(){this.element&&(this.element.style.display=""),this._visible=!1}});return b}),d("analytics",["event"],function(){function a(){this.init()}return a.prototype={init:function(){},pageView:function(a){ga("send","pageview",{page:window.location.pathname+window.location.hash,title:a})},event:function(){var a=[].splice.call(arguments,0),a=["send","event"].concat(a);ga.apply(ga,a)}},new a}),d("page",["section","analytics"],function(a,b){var c=a.extend({name:null,show:function(){this.name&&b.pageView(this.name)}});return c}),d("tapHandler",[],function(){function a(a,b){this.init(a,b)}return a.prototype={_element:null,_options:null,_distCutoff:20,_timeCutoff:500,_startType:null,_startTouchId:null,_startTime:null,_startX:null,_startY:null,_startDistance:null,_lastX:null,_lastY:null,_offset:null,_inGesture:!1,_ignoreGestures:!1,init:function(a,b){this._element=a,this._options=b,this._mouseDown=this._mouseDown.bind(this),this._touchDown=this._touchDown.bind(this),this._mouseMove=this._mouseMove.bind(this),this._touchMove=this._touchMove.bind(this),this._mouseUp=this._mouseUp.bind(this),this._touchUp=this._touchUp.bind(this),this._touchCancel=this._touchCancel.bind(this),this._down=this._down.bind(this),this._move=this._move.bind(this),this._end=this._end.bind(this),this._gestureStart=this._gestureStart.bind(this),this._gestureChange=this._gestureChange.bind(this),this._gestureEnd=this._gestureEnd.bind(this),this._offset={x:a.offsetLeft,y:a.offsetTop},this._element.addEventListener("mousedown",this._mouseDown),this._element.addEventListener("touchstart",this._touchDown)},ignoreGestures:function(a){this._ignoreGestures=a},_calculateMouseXY:function(a){a.x=a.clientX,a.y=a.clientY},_calculateTouchXY:function(a){var b=this._indexOfTouch(a,this._startTouchId);a.x=a.touches[b].clientX,a.y=a.touches[b].clientY},_calculateGestureXY:function(a){a.x=(a.touches[0].clientX+a.touches[1].clientX)/2,a.y=(a.touches[0].clientY+a.touches[1].clientY)/2},_mouseDown:function(a){this._startType="mouse",this._calculateMouseXY(a),this._down(a),document.addEventListener("mousemove",this._mouseMove),document.addEventListener("mouseup",this._mouseUp)},_touchDown:function(a){this._startType="touch",null===this._startTouchId&&(this._startTouchId=a.touches[a.touches.length-1].identifier),a.touches.length>=2&&!this._ignoreGestures?this._gestureStart(a):(this._calculateTouchXY(a),this._down(a)),document.addEventListener("touchmove",this._touchMove),document.addEventListener("touchend",this._touchUp),this._element.addEventListener("touchcancel",this._touchCancel)},_down:function(a){this._processEvent(a),this._startTime=Date.now(),this._startX=this._lastX=a.x,this._startY=this._lastY=a.y,this._options.start&&this._options.start(a)},_gestureStart:function(a){this._inGesture=!0,this._options.end&&(this._options.end(a),this._startTouchId=null),this._calculateGestureXY(a),this._startTime=Date.now(),this._startX=this._lastX=a.x,this._startY=this._lastY=a.y,this._startDistance=this._getGestureDistance(a),this._lastScale=1,this._options.gestureStart&&this._options.gestureStart(a)},_mouseMove:function(a){this._calculateMouseXY(a),this._move(a)},_touchMove:function(a){this._inGesture?this._gestureChange(a):(this._calculateTouchXY(a),this._move(a))},_move:function(a){this._processEvent(a),this._lastX=a.x,this._lastY=a.y,this._options.move&&this._options.move(a)},_gestureChange:function(a){this._calculateGestureXY(a),this._processEvent(a);var b=this._getGestureDistance(a);a.scale=b/this._startDistance,a.scaleFromLast=a.scale-this._lastScale,this._lastX=a.x,this._lastY=a.y,this._lastScale=a.scale,this._options.gesture&&this._options.gesture(a)},_mouseUp:function(a){document.removeEventListener("mousemove",this._mouseMove),document.removeEventListener("mouseup",this._mouseUp),this._end(a)},_touchUp:function(a){return this._inGesture?void this._gestureEnd(a):void(this._containsTouch(a,this._startTouchId)||(this._end(a),document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp),this._touchCancel()))},_end:function(a){this._processEvent(a),a.wasTap=!1;var b=Math.sqrt((this._lastX-this._startX)*(this._lastX-this._startX)+(this._lastY-this._startY)*(this._lastY-this._startY));b<this._distCutoff&&Date.now()-this._startTime<this._timeCutoff&&(a.wasTap=!0,this._options.tap&&this._options.tap(a)),this._options.end&&this._options.end(a),this._startX=null,this._startY=null,a.preventDefault(),a.stopImmediatePropagation()},_touchCancel:function(){this._startTouchId=null,this._element.removeEventListener("touchcancel",this._touchCancel)},_gestureEnd:function(a){a.touches.length>=2||(this._inGesture=!1,this._options.gestureEnd&&this._options.gestureEnd(a),document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp))},_processEvent:function(a){a.distFromLeft=a.x-this._offset.x,a.distFromTop=a.y-this._offset.y,a.xFromLast=a.x-this._lastX,a.yFromLast=a.y-this._lastY,a.distFromStartX=null!==this._startX?a.x-this._startX:0,a.distFromStartY=null!==this._startY?a.y-this._startY:0},_getGestureDistance:function(a){var b=a.touches[0].clientX-a.touches[1].clientX,c=a.touches[0].clientY-a.touches[1].clientY,d=Math.sqrt(b*b+c*c);return d},_containsTouch:function(a){return-1!==this._indexOfTouch(a,this._startTouchId)},_indexOfTouch:function(a,b){var c=-1;if(a.touches&&null!==b)for(var d=0;d<a.touches.length;d++)if(a.touches[d].identifier==b){c=d;break}return c},clear:function(){this._element.removeEventListener("mousedown",this._mouseDown),this._element.removeEventListener("touchstart",this._touchDown),document.removeEventListener("mousemove",this._mouseMove),document.removeEventListener("mouseup",this._mouseUp),document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp)}},a}),d("sections/login",["event","page","tapHandler","online","gauth","data"],function(a,b,c,d,e,f){var g=b.extend({id:"login",name:"Login",_basicBox:null,_fileBox:null,_fileTitleElement:null,_userProfileElement:null,_fileOwnersElement:null,_button:null,init:function(){this._super(),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._basicBox=document.getElementById("login-basic"),this._fileBox=document.getElementById("login-file"),this._fileTitleElement=document.getElementById("login-file-title"),this._userProfileElement=document.getElementById("login-owner-pic"),this._fileOwnersElement=document.getElementById("login-file-owners"),this._button=document.getElementById("loginbutton"),new c(this._button,{tap:this._loginClicked.bind(this)})},show:function(){this._super(),d.isOnline()&&(console.log("already online"),this._turnOnline()),a.addListener("onlineStatusChanged",this._onlineStatusChanged)},hide:function(){a.removeListener("onlineStatusChanged",this._onlineStatusChanged)},_onlineStatusChanged:function(){this._turnOnline()},displayFileInfo:function(a){this._basicBox.classList.add("hidden"),this._waitAnimationEnd().then(function(){var b=a.owners[0];this._fileTitleElement.textContent=a.title,this._fileOwnersElement.textContent=b.displayName,this._userProfileElement.src=b.picture.url,this._fileBox.classList.remove("hidden")}.bind(this))},_turnOnline:function(){this._button.classList.remove("disabled");var a=location.hash;0===a.indexOf("#")&&(a=a.slice(1),f.getRemoteFileInfo(a).then(function(a){this.displayFileInfo(a)}.bind(this)))},_waitAnimationEnd:function(){return new Promise(function(a){setTimeout(function(){a()},500)}.bind(this))},_loginClicked:function(){d.isOnline()&&e.authorizeWithPopup()}});return g}),d("platform",["class"],function(a){var b=a.extend({_b:null,standalone:null,transition:null,transitionEnd:null,animation:null,transform:null,transformOrigin:null,mouseWheel:null,init:function(){this._b=document.body,this.standalone=!!window.navigator.standalone,this.transition=this.addPrefix("transition"),this.transitionEnd={transition:"transitionend",webkitTransition:"webkitTransitionEnd",MozTransition:"transitionEnd",OTransition:"oTransitionEnd"}[this.transition],this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin"),this.mouseWheel="undefined"!=typeof window.onwheel?"wheel":"mousewheel",window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)},window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB||window.oIndexedDB},addPrefix:function(a){var b="",c=["ms","webkit","mox","o"],d=this._b.style;if("string"==typeof d[a])b="";else for(var e=0;e<c.length;e++)if("string"==typeof d["-"+c[e]+"-"+a]){b=c[e];break}var f=b.length>0?a.charAt(0).toUpperCase()+a.slice(1):a;return b?b+f:f}}),c=new b;return c}),d("sections/statusIndicator",["event","section","online","platform"],function(a,b,c){var d=b.extend({id:"mode",init:function(){this._super(),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),a.addListener("onlineStatusChanged",this._onlineStatusChanged),c.isOnline()||c.waitToComeOnline(1500).catch(function(){this._showOffline()}.bind(this))},_onlineStatusChanged:function(a){a.online?this._showOnline():this._showOffline()},_showOnline:function(){this.element.classList.add("hidden"),this._waitAnimationEnd().then(function(){this.element.textContent="Online",this.element.classList.remove("hidden"),this.element.classList.remove("offline")}.bind(this))},_showOffline:function(){this.element.classList.add("hidden"),this._waitAnimationEnd().then(function(){this.element.textContent="Offline",this.element.classList.remove("hidden"),this.element.classList.add("offline")}.bind(this))},_waitAnimationEnd:function(){return new Promise(function(a){setTimeout(function(){a()},500)}.bind(this))}});return d}),d("template",[],function(){function a(a){var b=document.getElementById("template-"+a),c=document.createElement("div");return c.innerHTML=b.innerHTML,c.children[0]}return a}),d("managers/modal",["section","tapHandler"],function(a,b){var c=a.extend({_overlayElement:null,_overallElement:null,_currentModal:null,init:function(){this._super(),this._overlayElement=document.getElementById("modal-overlay"),this._overallElement=document.getElementById("overall"),new b(this._overlayElement,{start:function(a){a.stopPropagation()},tap:this._overlayTapped.bind(this)})},show:function(a){null!==this._currentModal&&console.error("A modal is already showing"),this._currentModal=a,this.afterShow()},afterShow:function(){this._overlayElement.classList.remove("hidden"),this._super()},hide:function(){this.afterHide(),this._currentModal=null},afterHide:function(){this._overlayElement.classList.add("hidden"),this._super()},_overlayTapped:function(a){a.srcElement==this._overlayElement&&this._currentModal.tapOffCloses&&this._currentModal.hide()}});return new c}),d("components/modalBase",["section","managers/modal","tapHandler","analytics"],function(a,b,c,d){var e=a.extend({tapOffCloses:!0,init:function(){this._super(),new c(this.element,{start:function(a){a.stopPropagation()}})},show:function(){d.event("modal","shown",this.name),b.show(this)},hide:function(){d.event("modal","closed",this.name),b.hide()}});return e}),d("modals/share",["components/modalBase","tapHandler","data","event","online","platform","gauth","analytics"],function(a,b,c,d,e,f,g,h){var i=a.extend({id:"share-modal",name:"Share",_titleElement:null,_shareButton:null,_shareButtonText:null,_closeButton:null,_fileInfo:null,_offlineElement:null,_onlineElement:null,_loadingElement:null,_permissionsElement:null,_guestElement:null,_ownerElement:null,_linkElement:null,_linkTextElement:null,init:function(){this._super(),this._titleElement=document.getElementById("share-modal-title"),this._shareButton=document.getElementById("share-modal-share-button"),this._shareButtonText=document.getElementById("share-modal-share-text"),this._closeButton=document.getElementById("share-modal-close-button"),this._offlineElement=document.getElementById("share-modal-offline"),this._onlineElement=document.getElementById("share-modal-online"),this._loadingElement=document.getElementById("share-modal-loading"),this._permissionsElement=document.getElementById("share-modal-permissions"),this._guestElement=document.getElementById("share-modal-guest"),this._ownerElement=document.getElementById("share-modal-owner"),this._linkElement=document.getElementById("share-modal-link"),this._linkTextElement=document.getElementById("share-modal-link-text"),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),new b(this._shareButton,{start:function(a){a.stopPropagation()},tap:this._shareTapped.bind(this)}),this._linkTextElement.addEventListener("click",function(a){a.preventDefault()}),new b(this._closeButton,{start:function(a){a.stopPropagation()},tap:this._closeTapped.bind(this)})},show:function(a){this._super(),this._fileInfo=a,this._titleElement.textContent=a.name;var b=window.location.origin+window.location.pathname+"#"+a.id;this._linkTextElement.textContent=b,this._linkTextElement.href=b,this._loadingElement.classList.remove("hidden"),this._permissionsElement.classList.add("hidden"),e.isOnline()?this._showOnline(!0,!1):this._showOnline(!1,!1),d.addListener("onlineStatusChanged",this._onlineStatusChanged),this.afterShow()},hide:function(){this._super(),d.removeListener("onlineStatusChanged",this._onlineStatusChanged),this.afterHide()},_shareTapped:function(){var a="true"===this._shareButton.dataset.shared;a?Promise.resolve().then(function(){this._shareButtonText.textContent="Disabling..."}.bind(this)).then(function(){return c.disablePublicFile(this._fileInfo.id)}.bind(this)).then(function(){this._showShared(!1),h.event("file","shared","disabled")}.bind(this)).catch(function(a){console.error("failed to disable sharing",a)}):Promise.resolve().then(function(){this._shareButtonText.textContent="Sharing..."}.bind(this)).then(function(){return c.shareFilePublicly(this._fileInfo.id)}.bind(this)).then(function(){this._showShared(!0),h.event("file","shared","enabled")}.bind(this)).catch(function(a){console.error("failed to share",a)})},_closeTapped:function(){this.hide()},_checkForPermissions:function(){Promise.all([c.getRemoteFileInfo(this._fileInfo.id),c.getFilePermissions(this._fileInfo.id)]).then(function(a){var b=a[0],c=a[1],d="owner"==b.userPermission.role,e=c.some(function(a){return"anyone"==a.type&&"writer"==a.role});this._showPermission(d,e)}.bind(this))},_showOnline:function(a,b){a?(b?this._swapVisible(this._offlineElement,this._onlineElement,!0):(this._offlineElement.classList.add("hidden"),this._onlineElement.classList.remove("hidden")),this._checkForPermissions()):this._swapVisible(this._onlineElement,this._offlineElement,!0)},_showPermission:function(a,b){var c=this._showOwned(a);this._showShared(b),c.then(function(){this._swapVisible(this._loadingElement,this._permissionsElement,!0)}.bind(this))},_showOwned:function(a){return a?this._swapVisible(this._guestElement,this._ownerElement,!1):this._swapVisible(this._ownerElement,this._guestElement,!1)},_showShared:function(a){this._shareButton.dataset.shared=a,a?(this._shareButton.classList.remove("primary"),this._shareButton.classList.add("alert"),this._shareButtonText.textContent="Disable Sharing",this._linkElement.classList.remove("invisible")):(this._shareButton.classList.remove("alert"),this._shareButton.classList.add("primary"),this._shareButtonText.textContent="Share this file",this._linkElement.classList.add("invisible"))},_swapVisible:function(a,b,c){return c?new Promise(function(c){function d(){a.removeEventListener(f.transitionEnd,d),a.classList.add("hidden"),a.classList.remove("invisible"),b.classList.add("invisible"),b.classList.remove("hidden"),setTimeout(function(){b.classList.remove("invisible")},10),b.addEventListener(f.transitionEnd,e)}function e(){b.removeEventListener(f.transitionEnd,e),c()}a.addEventListener(f.transitionEnd,d),a.classList.add("invisible")}):(a.classList.add("hidden"),b.classList.remove("hidden"),Promise.resolve())},_onlineStatusChanged:function(a){this._showOnline(a.online,!0)}});return new i}),d("modals/delete",["components/modalBase","tapHandler","data","analytics"],function(a,b,c,d){var e=a.extend({id:"delete-modal",name:"Delete",_titleElement:null,_deleteButton:null,_closeButton:null,_fileInfo:null,init:function(){this._super(),this._titleElement=document.getElementById("delete-modal-title"),this._deleteButton=document.getElementById("delete-modal-delete"),this._closeButton=document.getElementById("delete-modal-close"),new b(this._deleteButton,{start:function(a){a.stopPropagation()},tap:this._deleteTapped.bind(this)}),new b(this._closeButton,{start:function(a){a.stopPropagation()},tap:this._closeTapped.bind(this)})},show:function(a){this._super(),this._fileInfo=a,this._titleElement.textContent=a.name,this.afterShow()},hide:function(){this._super(),this.afterHide()},_deleteTapped:function(){this.hide(),c.deleteFile(this._fileInfo.id).then(function(){d.event("file","deleted")}.bind(this))},_closeTapped:function(){this.hide()}});return new e}),d("sections/fileItem",["section","tapHandler","analytics","event","globals","helpers","platform","template","online","gauth","data","modals/share","modals/delete"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=a.extend({_fileList:null,_thumbnailInfoElement:null,_fileNameElement:null,_thumbnailElement:null,_fileInfo:null,_slideMax:null,_slideState:null,init:function(a,c){this._super(),this._fileList=a,this._fileInfo=c;var d=new h("fileListItem");if(this.setElement(d),this._thumbnailInfoElement=d.getElementsByClassName("thumbnail-info")[0],this._fileNameElement=d.getElementsByClassName("file-name")[0],this._thumbnailElement=d.getElementsByClassName("thumbnail")[0],this._fileNameElement.textContent=c.name,this._thumbnailElement.src=c.thumbnail,new b(this.element,{tap:this._docTapped.bind(this),start:this._docStarted.bind(this),move:this._docMoved.bind(this),end:this._docEnded.bind(this)}),e.isMobile()){this._thumbnailElement.style[g.transform]="translateX(0px);",this._thumbnailElement.translateX=0;{d.getElementsByClassName("delete")[0]}}},_docTapped:function(a){var b=a.target,c=f.parentEleWithClassname(b,"file-action"),d=f.parentEleWithClassname(b,"bar");if(c){var e=c.dataset.action;if("delete"==e)return m.show(this._fileInfo);if("share"==e)return l.show(this._fileInfo)}else{if(d)return;if(f.parentEleIsElement(b,this._thumbnailInfoElement))return this._fileList.drawFile(this._fileInfo)}},_docStarted:function(){if(e.isMobile()){this._slideState=null;var a=this._thumbnailInfoElement.getElementsByClassName("delete")[0];this._slideMax=-1*a.offsetWidth}},_docMoved:function(a){if(e.isMobile()){if(a.target!=this._thumbnailElement)return;var b=Math.sqrt(a.distFromStartX*a.distFromStartX+a.distFromStartY+a.distFromStartY);if(3>b?a.preventDefault():null===this._slideState&&(this._slideState=Math.abs(a.distFromStartX)>Math.abs(a.distFromStartY)?"sliding":"scrolling"),"sliding"==this._slideState){var c=this._thumbnailElement.translateX+a.xFromLast,d=Math.max(this._slideMax,Math.min(c,0));this._thumbnailElement.style[g.transform]="translateX("+d+"px)",this._thumbnailElement.translateX=d,a.preventDefault()}}},_docEnded:function(){e.isMobile()&&(this._slideState=null,this._thumbnailElement.classList.add("animating"),this._thumbnailElement.translateX<this._slideMax/3?(this._thumbnailElement.style[g.transform]="translateX("+this._slideMax+"px)",this._thumbnailElement.translateX=this._slideMax):(this._thumbnailElement.style[g.transform]="translateX(0px)",this._thumbnailElement.translateX=0),window.setTimeout(function(){this._thumbnailElement.classList.remove("animating")}.bind(this),300))},updateFileName:function(a){this._fileNameElement.textContent=a},updateThumbnail:function(a){this._thumbnailElement.src=a}});return n}),d("sections/fileList",["page","tapHandler","analytics","event","globals","helpers","online","gauth","sections/statusIndicator","sections/fileItem","data"],function(a,b,c,d,e,f,g,h,i,j,k){var l=a.extend({id:"files-list-container",name:"File List",_filesPane:null,_fileListElement:null,_files:null,_updateTimeout:null,_indicator:null,_itemWidth:null,init:function(a){this._super(),this._filesPane=a,this._files=[],this._indicator=new i,this._fileListElement=document.getElementById("files-list"),this._scheduleUpdate=this._scheduleUpdate.bind(this),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._authenticatedStatusChanged=this._authenticatedStatusChanged.bind(this),k.getFiles().then(function(a){for(var b=0;b<a.length;b++){var c=a[b],d=this._newFileWrapper(c);this._fileListElement.appendChild(d)}}.bind(this)),this.element.addEventListener("wheel",function(a){a.stopPropagation()}),new b(document.getElementById("create-file"),{tap:this._createTapped.bind(this)}),d.addListener("fileAdded",this._fileAdded.bind(this)),d.addListener("fileRemoved",this._fileRemoved.bind(this)),d.addListener("fileModified",this._fileModified.bind(this)),d.addListener("fileRenamed",this._fileRenamed.bind(this)),d.addListener("fileIdChanged",this._fileIdChanged.bind(this)),d.addListener("fileModifiedRemotely",this._fileModifiedRemotely.bind(this)),d.addListener("thumbnailUpdated",this._thumbnailUpdated.bind(this))},_newFileWrapper:function(a){var b=new j(this,a);return b.element.fileInfo=a,this._files.push({fileInfo:a,fileItem:b,element:b.element}),b.element},show:function(){this._super(),d.addListener("onlineStatusChanged",this._onlineStatusChanged),d.addListener("authenticatedStatusChanged",this._authenticatedStatusChanged),g.isOnline()&&k.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this))},hide:function(){d.removeListener("onlineStatusChanged",this._onlineStatusChanged),d.removeListener("authenticatedStatusChanged",this._authenticatedStatusChanged),this._updateTimeout&&clearTimeout(this._updateTimeout)},_scheduleUpdate:function(){this._updateTimeout&&clearTimeout(this._updateTimeout),this._updateTimeout=setTimeout(function(){this._visible&&g.isOnline()&&k.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this))}.bind(this),15e3)},drawFile:function(a){this._filesPane.setPane("draw",a)
},_createTapped:function(){return k.createFile().then(function(a){return a.fileInfoPromise}).then(function(a){console.log("Showing draw for",a),this._filesPane.setPane("draw",a),c.event("file","created")}.bind(this))},_onlineStatusChanged:function(a){a.online&&h.isAuthenticated()&&k.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},_authenticatedStatusChanged:function(a){a.authenticated&&k.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},_fileAdded:function(a){var b=this._newFileWrapper(a);this._fileListElement.insertBefore(b,this._fileListElement.children[1])},_fileRemoved:function(a){for(var b in this._files){var c=this._files[b];if(c.fileInfo.id==a)return this._fileListElement.removeChild(c.element),void delete this._files[b]}},_fileModified:function(a){for(var b in this._files){var c=this._files[b];if(c.fileInfo.id==a.id)return c.fileInfo.modifiedTime=a.modifiedTime,this._fileListElement.removeChild(c.element),void this._fileListElement.insertBefore(c.element,this._fileListElement.children[1])}},_fileRenamed:function(a){for(var b in this._files){var c=this._files[b];if(c.fileInfo.id==a.id)return c.fileItem.updateFileName(a.name),void(c.fileInfo.name=a.name)}},_fileIdChanged:function(a){for(var b in this._files){var c=this._files[b];if(c.fileInfo.id==a.oldId){c.fileInfo.id=a.newId;break}}},_fileModifiedRemotely:function(){},_thumbnailUpdated:function(a){for(var b in this._files){var c=this._files[b];if(c.fileInfo.id==a.id)return c.fileItem.updateThumbnail(a.thumbnail),void(c.fileInfo.thumbnail=a.thumbnail)}}});return l}),d("sections/draw",["page","globals","event","helpers","tapHandler","platform","db","bezierCurve","data","online","components/drawCanvas","analytics"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=a.extend({id:"draw",name:"Draw Pane",_filesPane:null,_drawCanvas:null,_canvas:null,_file:null,_settings:null,_currentAction:null,_update:!1,_updateAll:!0,_manipulating:!1,_updateCurrentAction:!1,_shouldRender:!1,_saveSettingsTimeout:null,_manipulateTimeout:null,_fileSyncTimeout:null,_canvasTapHandler:null,_toolTapHandler:null,_fileNameElement:null,_overlay:null,init:function(a){this._super(),this._filesPane=a,this._canvas=document.getElementById("canvas"),this._actionsAdded=this._actionsAdded.bind(this),this._actionsRemoved=this._actionsRemoved.bind(this),this._resize=this._resize.bind(this),this._fileModifiedRemotely=this._fileModifiedRemotely.bind(this),this._fileRenamed=this._fileRenamed.bind(this),this._redraw=this._redraw.bind(this),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._scheduleManipulateTimeout=this._scheduleManipulateTimeout.bind(this),this.element.addEventListener("touchmove",function(a){a.preventDefault()}),this._canvasTapHandler=new e(this.element,{start:this._start.bind(this),move:this._move.bind(this),end:this._end.bind(this),gesture:this._gesture.bind(this)}),this._toolTapHandler=new e(document.getElementById("tools"),{tap:this._toolChanged.bind(this),start:this._toolStart.bind(this),end:this._toolEnd.bind(this)}),new e(document.getElementById("menu"),{start:function(a){a.stopPropagation()},tap:this._menuTapped.bind(this)}),new e(document.getElementById("fileName"),{start:function(a){a.stopPropagation()}}),new e(document.getElementById("colorPicker"),{start:function(a){a.stopPropagation()},tap:this._colorPicked.bind(this)}),this._overlay=document.getElementById("draw-overlay"),this._overlay.addEventListener("mousedown",this._hideModal.bind(this)),this._overlay.addEventListener("touchstart",this._hideModal.bind(this)),this.element.addEventListener(f.mouseWheel,this._mouseWheel.bind(this)),this.element.addEventListener("keydown",this._keyDown.bind(this)),this._fileNameElement=document.getElementById("fileName"),this._fileNameElement.addEventListener("keydown",this._fileNameKeyDown.bind(this)),this._fileNameElement.addEventListener("blur",this._fileNameBlur.bind(this))},show:function(a){return this._super(),this._tryLoadFile(a).catch(function(){return j.waitToComeOnline(1e4).then(function(){return i.loadFileFromRemote(a.id)}.bind(this)).then(function(a){return this._tryLoadFile(a)}.bind(this)).catch(function(a){console.error("Unable to draw for this file",a),l.event("draw","load failure"),location.hash="",this._filesPane.setPane("list")}.bind(this))}.bind(this))},_tryLoadFile:function(a){return i.loadFile(a.id).then(function(a){this._file=a,a.listen(this._actionsAdded,this._actionsRemoved),a.fileInfoPromise.then(function(a){this._fileNameElement.value=a.name}.bind(this)),a.localSettings().then(function(a){this._settings=a,document.getElementById("chosenColorSwatch").style.backgroundColor=this._settings.color,this._setActiveTool(),this._drawCanvas=new k(this._canvas,this._settings),this._redraw(),this._scheduleUpdate()}.bind(this)),this._updateAll=!0,this._shouldRender=!0,c.addListener("fileModifiedRemotely",this._fileModifiedRemotely),c.addListener("fileRenamed",this._fileRenamed),c.addListener("onlineStatusChanged",this._onlineStatusChanged),this._resize(),setTimeout(function(){this._canvas.focus()}.bind(this),400),window.addEventListener("resize",this._resize)}.bind(this))},hide:function(){location.hash&&(location.hash=""),this._file&&(this._file.stopListening(),window.setTimeout(function(){this._file.updateThumbnail().then(function(a){return i.close(a)}.bind(this,this._file)).catch(function(a){console.error(a,a.stack,a.message)})}.bind(this),600)),this._shouldRender=!1,c.removeListener("fileModifiedRemotely",this._fileModifiedRemotely),c.removeListener("fileRenamed",this._fileRenamed),c.removeListener("onlineStatusChanged",this._onlineStatusChanged),window.removeEventListener("resize",this._resize)},_actionsAdded:function(a){a.isLocal?(this._update=!0,this._drawCanvas.addAction(a.items[0])):this._updateAll=!0},_actionsRemoved:function(){this._updateAll=!0},_resize:function(){this._canvas.width=window.innerWidth*window.devicePixelRatio,this._canvas.height=window.innerHeight*window.devicePixelRatio,this._updateAll=!0},_zoom:function(a,b,c){var d=this._screenToRetina(a,b);this._drawCanvas.zoom(d.x,d.y,c)&&(this._saveSettings(),this._drawCanvas.rasterMode(!0),this._manipulating=!0,this._scheduleManipulateTimeout())},_pan:function(a,b){var c=this._screenToRetina(a,b);this._drawCanvas.pan(c.x,c.y)&&(this._saveSettings(),this._drawCanvas.rasterMode(!0),this._manipulating=!0,this._scheduleManipulateTimeout())},_scheduleManipulateTimeout:function(){this._manipulateTimeout&&clearTimeout(this._manipulateTimeout),this._manipulateTimeout=setTimeout(function(){this._drawCanvas.rasterMode(!1),this._manipulating=!1,this._updateAll=!0}.bind(this),50)},_mouseWheel:function(a){var b=isNaN(a.deltaX)?a.wheelDeltaX/5:-a.deltaX,c=isNaN(a.deltaY)?a.wheelDeltaY/5:-a.deltaY;"pan"==this._settings.tools.scroll?this._pan(b,c):"zoom"==this._settings.tools.scroll&&0!=c&&this._zoom(a.clientX,a.clientY,c/100*this._settings.scale),a.preventDefault()},_start:function(a){var b=this._settings.tools.gesture||this._settings.tools.point;if(1==a.button&&(b="pan"),"pan"!=b){var c=this._screenToWorld(this._settings,a.distFromLeft,a.distFromTop);this._currentAction&&console.error("Current action isn't null!"),this._currentAction={type:"stroke",value:{points:[[c.x,c.y]],width:2,lockWidth:!0,color:this._settings.color}},"eraser"==b?(this._currentAction.value.width=30/this._settings.scale,this._currentAction.value.color="#ffffff",this._currentAction.value.lockWidth=!1):"pencil"==this._settings.tools.point}},_move:function(a){var b=this._settings.tools.gesture||this._settings.tools.point;if(1==a.button&&(b="pan"),"pan"==b)this._pan(a.xFromLast,a.yFromLast);else if("pencil"==b||"eraser"==b){if(!this._currentAction)return;var c=this._screenToWorld(this._settings,a.distFromLeft,a.distFromTop),d=this._currentAction.value,e=d.points,f=e[e.length-1],g=Math.sqrt((f[0]-c[0])*(f[0]-c[0])+(f[1]-c[1])*(f[1]-c[1]));if(.001>g)return;d.points.push([c.x,c.y]),this._updateCurrentAction=!0}},_end:function(){var a=this._settings.tools.gesture||this._settings.tools.point;if("pencil"==a||"eraser"==a){if(!this._currentAction)return;var b=this._currentAction;this._currentAction=null;var c=b.value;if(c.points.length<2)return;var e=d.cloneArray(h.getCurveControlPoints(c.points));c.controlPoints=e,this._updateCurrentAction=!0,this._updateAll=!0,this._saveAction(b),l.event("draw","new action")}},_saveAction:function(a){a.id=d.getGuid(),this._file.addAction(a).catch(function(a){console.error(a,a.stack,a.message)})},_gesture:function(a){this._pan(a.xFromLast,a.yFromLast),this._zoom(a.x,a.y,a.scaleFromLast*this._settings.scale)},_redraw:function(){if(this._shouldRender){if(this._updateAll){var a=this._file.getActions();this._drawCanvas.doAll(a)}if(this._updateCurrentAction&&this._currentAction){var b=this._currentAction,c=h.getCurveControlPoints(b.value.points);b.value.controlPoints=c,this._drawCanvas.doTemporaryAction(b)}(this._updateAll||this._updateCurrentAction||this._update||this._manipulating)&&(this._drawCanvas.render(),this._update=!1,this._updateAll=!1,this._updateCurrentAction=!1,this._manipulating=!1),requestAnimationFrame(this._redraw)}},_menuTapped:function(a){if("LI"==a.target.tagName){var b=a.target.dataset.action;"back"==b?this._file.fileInfoPromise.then(function(a){this._filesPane.setPane("list",a)}.bind(this)):"rename"==b&&a.target.focus()}},_showModal:function(a){var b=document.getElementById(a);return b?(this._overlay.currentModal=a,this._overlay.style.visibility="visible",void setTimeout(function(){b.classList.add("visible")},0)):void console.error("No modal with that id")},_hideModal:function(a){if(!a||a.target==this._overlay){if(this._overlay.currentModal){var b=document.getElementById(this._overlay.currentModal);if(b.dataset.closeable&&"false"===b.dataset.closeable)return void(a&&a.stopPropagation());b.classList.remove("visible"),this._overlay.currentModal=""}this._overlay.style.visibility="hidden"}},_colorPicked:function(a){var b=d.parentEleWithClassname(a.target,"swatch");if(b){var c=b.style.backgroundColor;this._settings.color=c,this._saveSettings(),document.getElementById("chosenColorSwatch").style.backgroundColor=c,this._hideModal()}a.stopPropagation()},_toolStart:function(a){{var b=a.target.dataset.tool;a.target.dataset.action}"LI"==a.target.tagName&&b&&("pan"==b||"eraser"==b||"pencil"==b)&&(this._settings.tools.gesture=b,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!0),this._toolTapHandler.ignoreGestures(!0)),a.stopPropagation(),a.preventDefault()},_toolEnd:function(a){if(a){var b=a.target.dataset.tool;"LI"==a.target.tagName&&b&&("pan"==b||"eraser"==b||"pencil"==b)&&(this._settings.tools.gesture=null,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!1),this._toolTapHandler.ignoreGestures(!1))}},_toolChanged:function(a){var c=d.parentEleWithClassname(a.target,"toolitem");if(c&&"LI"==c.tagName){var e=c.dataset.action,f=c.dataset.tool;f?("pencil"==f?this._settings.tools.point="pencil":"eraser"==f?this._settings.tools.point="eraser":"pan"==f?b.isComputer()?this._settings.tools.scroll="pan":this._settings.tools.point="pan":"zoom"==f&&(this._settings.tools.scroll="zoom"),this._setActiveTool(),this._saveSettings()):e&&("undo"==e?this._undo():"redo"==e&&this._redo(),"color"==e&&(this._showModal("colorPicker"),a.preventDefault(),a.stopImmediatePropagation()))}},_setActiveTool:function(){function a(a){var b=c.dataset["active"+a];if(b){var d=document.getElementById(b);d.classList.remove("active-"+a)}var e=this._settings.tools[a];if(e){var f=e+"-tool",g=document.getElementById(f);g.classList.add("active-"+a),c.dataset["active"+a]=f}else delete c.dataset["active"+a]}var c=document.getElementById("tools");a=a.bind(this),a("point"),b.isComputer()&&a("scroll")},_keyDown:function(a){var c=String.fromCharCode(a.keyCode);b.isMac()&&a.metaKey&&a.shiftKey&&"Z"==c||b.isPC()&&a.ctrlKey&&"Y"==c?this._redo():(b.isMac()&&a.metaKey||b.isPC()&&a.ctrlKey)&&"Z"==c?(a.preventDefault(),this._undo()):"Z"==c?(this._settings.tools.scroll="zoom",this._setActiveTool()):"P"==c&&(this._settings.tools.scroll="pan",this._setActiveTool())},_undo:function(){this._file.undo(),this._updateAll=!0,l.event("draw","undo")},_redo:function(){this._file.redo(),this._updateAll=!0,l.event("draw","redo")},_fileNameKeyDown:function(a){13==a.keyCode&&this._fileNameElement.blur()},_fileNameBlur:function(a){var b=a.target.value;this._file.rename(b),l.event("file","renamed","draw")},_saveSettings:function(){this._saveSettingsTimeout&&clearTimeout(this._saveSettingsTimeout),this._saveSettingsTimeout=setTimeout(function(){this._file.localSettings(this._settings)}.bind(this),100)},_fileModifiedRemotely:function(a){this._file.fileInfoPromise.then(function(b){a.id==b.id&&(this._updateAll=!0)}.bind(this))},_fileRenamed:function(a){this._file.fileInfoPromise.then(function(b){b.id==a.id&&(this._fileNameElement.value=a.name)}.bind(this))},_onlineStatusChanged:function(a){a.online&&this._file.isConnected()&&this._file.sync(null,!0).then(function(){this._scheduleUpdate()}.bind(this)).catch(function(a){console.error(a,a.stack,a.message)})},_scheduleUpdate:function(){this._fileSyncTimeout&&clearTimeout(this._fileSyncTimeout),this._fileSyncTimeout=setTimeout(function(){return this._visible?this._currentAction?(console.log("We are currently drawing, delaying sync"),void this._scheduleUpdate()):void(this._file.isConnected()?this._file.sync(null,!1).then(function(){this._scheduleUpdate()}.bind(this)):this._scheduleUpdate()):void 0}.bind(this),15e3)},_screenToRetina:function(a,b){var c=window.devicePixelRatio;return{x:a*c,y:b*c}},_screenToWorld:function(a,b,c){var e=this._screenToRetina(b,c);return d.screenToWorld(a,e.x,e.y)}});return m}),d("managers/files",["section","event","platform","data","sections/fileList","sections/draw"],function(a,b,c,d,e,f){var g=a.extend({id:"files",_paneWrapper:null,_screenWidth:0,panes:null,currentPaneName:null,_currentState:null,init:function(){this._super(),this._screenWidth=window.innerWidth,this._paneWrapper=document.getElementById("files-pane-wrapper"),this._windowResized=this._windowResized.bind(this),this._finishedSliding=this._finishedSliding.bind(this),this._paneWrapper.addEventListener(c.transitionEnd,this._finishedSliding),this.panes={},this.panes.list={offsetX:0,pane:new e(this)},this.panes.draw={offsetX:this._screenWidth,pane:new f(this)},this.panes.draw.pane.element.style[c.transform]="translate("+this._screenWidth+"px, 0px)",this._currentState={pane:"list",details:null},localStorage.filesPane&&(this._currentState=JSON.parse(localStorage.filesPane));var a=location.hash;0===a.indexOf("#")&&(a=a.slice(1),this._currentState.pane="draw",this._currentState.details={id:a}),b.addListener("fileIdChanged",this._fileIdChanged.bind(this))},show:function(){this.setPane(this._currentState.pane,this._currentState.details),this._redoOffsets(),window.addEventListener("resize",this._windowResized)},hide:function(){window.removeEventListener("resize",this._windowResized)},setPane:function(a,b){if(this.currentPaneName!=a){var d=null;if(this.currentPaneName){var d=this.panes[this.currentPaneName].pane;d.hide&&d.hide(),d.afterHide()}d=this.panes[a].pane,d.show&&d.show(b),d.afterShow(),this.currentPaneName=a;var e=this.panes[a],f="translate("+-1*e.offsetX+"px, 0px)";this._paneWrapper.style[c.transform]!=f&&(this._paneWrapper.classList.add("ani4"),this._paneWrapper.style[c.transform]=f),this._currentState={pane:"list",details:null},"list"!=a&&(this._currentState.pane=a,this._currentState.details=b),localStorage.filesPane=JSON.stringify(this._currentState)}},_finishedSliding:function(a){a.target==this._paneWrapper&&(this._paneWrapper.classList.remove("ani4"),this._redoOffsets())},_windowResized:function(){this._redoOffsets()},_redoOffsets:function(){this._screenWidth=window.innerWidth;var a=0;for(var b in this.panes){if(this.currentPaneName==b)break;a++}var d=-1*a*this._screenWidth;for(var b in this.panes)this.panes[b].offsetX=d,this.panes[b].pane.element.style[c.transform]="translate("+d+"px, 0px)",d+=this._screenWidth;this._paneWrapper.style[c.transform]=""},_fileIdChanged:function(a){this._currentState.details&&this._currentState.details.id==a.newId&&(localStorage.filesPane=JSON.stringify(this._currentState))}});return g}),d("sections/main",["section","event","managers/files"],function(a,b,c){var d=a.extend({id:"main-container",mainContent:null,panes:null,currentPane:"",init:function(){this._super(),this.mainContent=document.getElementById("main-content"),this.panes={},this.panes.files=new c,b.addListener("logout",this._logout.bind(this))},show:function(){this.setPane(localStorage.currentPane?localStorage.currentPane:"files")},setPane:function(a){if(this.currentPane!=a){var c=null;if(this.currentPane){var c=this.panes[this.currentPane];c.hide&&c.hide(),c.afterHide()}c=this.panes[a],c.show&&c.show(),c.afterShow(),this.currentPane=a,localStorage.currentPane=a,b.trigger("paneChanged",{pane:c})}},_logout:function(){delete localStorage.currentPane}});return d}),d("managers/login",["event","gauth","sections/login","sections/main"],function(a,b,c,d){function e(){this.init()}return e.prototype={pages:null,currentPage:"",init:function(){this.pages={},a.addListener("authenticatedStatusChanged",this._authenticatedStatusChanged.bind(this)),this.pages.login=new c,this.pages.main=new d,this.setPage(localStorage.loggedIn?"main":"login")},setPage:function(a){var b=null;this.currentPage&&(b=this.pages[this.currentPage],b.hide&&b.hide(),b.afterHide()),b=this.pages[a],b.show&&b.show(),b.afterShow(),this.currentPage=a},_authenticatedStatusChanged:function(a){a.authenticated?(localStorage.loggedIn=!0,this.setPage("main")):(localStorage.loggedIn=!1,this.setPage("login"))}},e}),function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/cast",["exports"],function(a){function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.cast=b}),a("promise/config",["exports"],function(a){function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){function d(){var a="Promise"in window&&"cast"in window.Promise&&"resolve"in window.Promise&&"reject"in window.Promise&&"all"in window.Promise&&"race"in window.Promise&&function(){var a;return new window.Promise(function(b){a=b}),f(a)}();a||(window.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./cast","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h,i){function j(a){if(!w(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof j))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],k(a,this)}function k(a,b){function c(a){p(b,a)}function d(a){r(b,a)}try{a(c,d)}catch(e){d(e)}}function l(a,b,c,d){var e,f,g,h,i=w(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;o(b,e)||(i&&g?p(b,e):h?r(b,f):a===F?p(b,e):a===G&&r(b,e))}function m(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+F]=c,e[f+G]=d}function n(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],l(b,c,d,f);a._subscribers=null}function o(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(v(b)&&(d=b.then,w(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?p(a,d):q(a,d)))},function(b){return c?!0:(c=!0,void r(a,b))}),!0}catch(e){return c?!0:(r(a,e),!0)}return!1}function p(a,b){a===b?q(a,b):o(a,b)||q(a,b)}function q(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(s,a))}function r(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(t,a))}function s(a){n(a,a._state=F)}function t(a){n(a,a._state=G)}var u=a.config,v=(a.configure,b.objectOrFunction),w=b.isFunction,x=(b.now,c.cast),y=d.all,z=e.race,A=f.resolve,B=g.reject,C=h.asap;u.async=C;var D=void 0,E=0,F=1,G=2;j.prototype={constructor:j,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;u.async(function(){l(c._state,d,e[c._state-1],c._detail)})}else m(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},j.all=y,j.cast=x,j.race=z,j.resolve=A,j.reject=B,i.Promise=j}),a("promise/race",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){function b(a){var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}(),d("promise",function(){}),d("sections/updateMessage",["event","section","tapHandler"],function(a,b,c){var d=b.extend({id:"updateBar",init:function(){this._super();var a=document.getElementById("updateBarContent");new c(a,{tap:this._buttonClicked.bind(this)})},show:function(){this.element.classList.add("visible")},hide:function(){this.element.classList.remove("visible")},_buttonClicked:function(){location.reload()}});return new d}),d("cacheHandler",["sections/updateMessage"],function(a){function b(){this.init()}return b.prototype={init:function(){},updateReady:function(){a.show()}},new b}),"interactive"===document.readyState||"complete"===document.readyState?a():document.addEventListener("DOMContentLoaded",a,!1),window.Promise||c(["promise"],function(a){window.Promise=a}),window.gapiLoaded=function(){c(["online"],function(a){a.gapiLoaded()})},window.gapiLoadError=function(){c(["online"],function(a){a.gapiLoadError()})},window.applicationCache.addEventListener("updateready",function(){c(["cacheHandler"],function(a){a.updateReady()})}),d("main",function(){})}();
